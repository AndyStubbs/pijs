/**
 * Pi.js - Graphics and Sound Library
 * @version 2.0.0-alpha.2
 * @author Andy Stubbs
 * @license Apache-2.0
 * @preserve
 */
var mr=Object.defineProperty;var W=(e,t)=>{for(var r in t)mr(e,r,{get:t[r],enumerable:!0})};var Y={};W(Y,{calcColorDifference:()=>Me,clamp:()=>ye,convertToColor:()=>G,degreesToRadian:()=>$e,errFn:()=>_e,generateColorKey:()=>_t,getFloat:()=>Te,getInt:()=>V,hexToData:()=>hr,inRange:()=>Ie,inRange2:()=>Er,isDomElement:()=>We,isFunction:()=>H,isObjectLiteral:()=>ue,pad:()=>xr,padL:()=>vt,parseOptions:()=>ae,queueMicrotask:()=>ne,radiansToDegrees:()=>Cr,rgbToColor:()=>$,rndRange:()=>ce,setColor:()=>He});var _e=e=>{let t=new Error(`${e}: No screens available for command. You must first create a screen with $.screen command.`);throw t.code="NO_SCREEN",t};function ae(e,t){let r={};for(let n of t)r[n]=null;let o=!1;if(e.length>0&&ue(e[0])){let n=e[0];for(let i of t)i in n&&(o=!0,r[i]=n[i])}if(!o)for(let n=0;n<t.length;n++)n<e.length&&(r[t[n]]=e[n]);return r}var H=e=>typeof e=="function",We=e=>e instanceof Element,ue=e=>{if(typeof e!="object"||e===null||Array.isArray(e))return!1;let t=Object.getPrototypeOf(e);return t===null||t===Object.prototype};function hr(e,t,r){e=e.toUpperCase();let o=[],n=0,i="",l=0;for(let s=0;s<r;s++){o.push([]);for(let a=0;a<t;a++){if(l>=i.length){let c=parseInt(e[n],16);isNaN(c)&&(c=0),i=vt(c.toString(2),4,"0"),n+=1,l=0}o[s].push(parseInt(i[l])),l+=1}}return o}function ye(e,t,r){return Math.min(Math.max(e,t),r)}function Ie(e,t){return e.x>=t.x&&e.x<t.x+t.width&&e.y>=t.y&&e.y<t.y+t.height}function Er(e,t,r,o,n,i){return e>=r&&e<r+n&&t>=o&&t<o+i}function ce(e,t){return Math.random()*(t-e)+e}function $e(e){return e*(Math.PI/180)}function Cr(e){return e*(180/Math.PI)}function vt(e,t,r){typeof r!="string"&&(r=" ");let o="";e=e+"";for(let n=e.length;n<t;n++)o+=r;return o+e}function xr(e,t,r){for((typeof r!="string"||r.length===0)&&(r=" "),e=e+"";e.length<t;)e=r+e+r;return e.length>t&&(e=e.substring(0,t)),e}function V(e,t){if(e==null)return t;let r=Number(e);return Number.isFinite(r)?Math.round(r):t}function Te(e,t){if(e==null)return t;let r=Number(e);return Number.isFinite(r)?r:t}var ne=e=>{window.queueMicrotask?window.queueMicrotask(e):setTimeout(e,0)},bt={key:0,r:0,g:0,b:0,a:0,rgba:"",hex:""},ve=document.createElement("canvas").getContext("2d",{willReadFrequently:!0});function _t(e,t,r,o){return e<<24|t<<16|r<<8|o}function $(e,t,r,o){let n=Fr(e,t,r,o);return yt(e,t,r,o,n)}function G(e){if(e==null||e==="")return null;if(Object.getPrototypeOf(e)===bt)return e;if(Array.isArray(e)){if(e.length<3)return null;e.length===3&&e.push(255)}else if(e.r!==void 0)e=[e.r,e.g,e.b,e.a];else if(typeof e=="string"){if(/(^#[0-9A-F]{8}$)|(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(e))return wr(e);if(e.indexOf("rgb")===0){if(e=Ar(e),e.length<3)return null;e.length===3&&e.push(255)}else return Rr(e)}for(let t=0;t<3;t+=1)e[t]=V(e[t],0);return e[3]=Te(e[3],0),e[3]<1?e[3]=Math.round(e[3]*255):e[3]=Math.round(e[3]),$(e[0],e[1],e[2],e[3])}function Me(e,t,r=[.2,.68,.07,.05]){let o=e.r-t.r,n=e.g-t.g,i=e.b-t.b,l=e.a-t.a;return o*o*r[0]+n*n*r[1]+i*i*r[2]+l*l*r[3]}function yt(e,t,r,o,n){let i=Object.create(bt);return i.key=_t(e,t,r,o,n),i.r=e,i.g=t,i.b=r,i.a=o,i.rgba=`rgba(${e},${t},${r},${(o/255).toFixed(3)})`,i.hex=n,i}function He(e,t){t.key=e.key,t.r=e.r,t.g=e.g,t.b=e.b,t.a=e.a,t.rgba=e.rgba,t.hex=e.hex}function wr(e){let t,r,o,n;return e.length===4?(t=parseInt(e.slice(1,2),16)*16-1,r=parseInt(e.slice(2,3),16)*16-1,o=parseInt(e.slice(3,4),16)*16-1):(t=parseInt(e.slice(1,3),16),r=parseInt(e.slice(3,5),16),o=parseInt(e.slice(5,7),16)),e.length===9?n=parseInt(e.slice(7,9),16):n=255,yt(t,r,o,n,e)}function Ar(e){e=e.slice(e.indexOf("(")+1,e.indexOf(")"));let t=e.split(","),r=[];for(let o=0;o<t.length;o++){let n;o===3?(n=parseFloat(t[o].trim()),n<=1&&(n*=255)):n=parseInt(t[o].trim()),r.push(n)}return r}function be(e){Number.isInteger(e)||(e=Math.round(e)),e=ye(e,0,255);let t=Number(e).toString(16);return t.length<2?"0"+t:t.toUpperCase()}function Fr(e,t,r,o){return isNaN(o)&&(o=255),"#"+be(e)+be(t)+be(r)+be(o)}function Rr(e){ve.clearRect(0,0,1,1),ve.fillStyle=e,ve.fillRect(0,0,1,1);let t=ve.getImageData(0,0,1,1).data;return $(t[0],t[1],t[2],t[3])}var j={};W(j,{addCommand:()=>y,addSetting:()=>Qo,done:()=>Xe,init:()=>Ko,processCommands:()=>ht,set:()=>sr,wait:()=>mt});var q={};W(q,{CANVAS2D_RENDER_MODE:()=>U,WEBGL2_RENDER_MODE:()=>ie,activeScreenData:()=>te,addScreenCleanupFunction:()=>it,addScreenDataItem:()=>Oe,addScreenDataItemGetter:()=>fe,addScreenInitFunction:()=>Ae,addScreenResizeFunction:()=>De,getActiveScreen:()=>de,getAllScreens:()=>nt,init:()=>Oo});var D={};W(D,{IMAGE_BATCH:()=>X,POINTS_BATCH:()=>Q,blendModeChanged:()=>qt,cleanup:()=>tt,cls:()=>ho,deleteWebGL2Texture:()=>ot,drawImage:()=>Ro,drawPixelUnsafe:()=>wo,getWebGL2Texture:()=>Jt,init:()=>fo,initWebGL:()=>Ce,isWebgl2Capable:()=>Ee,prepareBatch:()=>rt,readPixel:()=>Zt,readPixelAsync:()=>Ao,readPixels:()=>Qt,readPixelsAsync:()=>Fo,setImageDirty:()=>Ht});var he={};W(he,{BLENDS:()=>Qe,BLEND_ALPHA:()=>Je,BLEND_REPLACE:()=>le,PENS:()=>Ze,PEN_CIRCLE:()=>Le,PEN_PIXEL:()=>ee,PEN_SQUARE:()=>Se,init:()=>jr});var Be={};W(Be,{buildGraphicsApi:()=>Pe,init:()=>Hr});var ge={};W(ge,{findColorIndexByColorValue:()=>Z,getColorValueByIndex:()=>je,getColorValueByRawInput:()=>qe,init:()=>vr});var K=[],Ne=new Map,pe=-1;function vr(e){It({pal:["#0000AA","#00AA00","#00AAAA","#AA0000","#AA00AA","#AA5500","#AAAAAA","#555555","#5555FF","#55FF55","#55FFFF","#FF5555","#FF55FF","#FFFF55","#FFFFFF","#000000","#141414","#202020","#2D2D2D","#393939","#454545","#515151","#616161","#717171","#828282","#929292","#A2A2A2","#B6B6B6","#CACACA","#E3E3E3","#FFFFFF","#0000FF","#4100FF","#7D00FF","#BE00FF","#FF00FF","#FF00BE","#FF007D","#FF0041","#FF0000","#FF4100","#FF7D00","#FFBE00","#FFFF00","#BEFF00","#7DFF00","#41FF00","#00FF00","#00FF41","#00FF7D","#00FFBE","#00FFFF","#00BEFF","#007DFF","#0041FF","#7D7DFF","#9E7DFF","#BE7DFF","#DF7DFF","#FF7DFF","#FF7DDF","#FF7DBE","#FF7D9E","#FF7D7D","#FF9E7D","#FFBE7D","#FFDF7D","#FFFF7D","#DFFF7D","#BEFF7D","#9EFF7D","#7DFF7D","#7DFF9E","#7DFFBE","#7DFFDF","#7DFFFF","#7DDFFF","#7DBEFF","#7D9EFF","#B6B6FF","#C6B6FF","#DBB6FF","#EBB6FF","#FFB6FF","#FFB6EB","#FFB6DB","#FFB6C6","#FFB6B6","#FFC6B6","#FFDBB6","#FFEBB6","#FFFFB6","#EBFFB6","#DBFFB6","#C6FFB6","#B6FFB6","#B6FFC6","#B6FFDB","#B6FFEB","#B6FFFF","#B6EBFF","#B6DBFF","#B6C6FF","#000071","#1C0071","#390071","#550071","#710071","#710055","#710039","#71001C","#710000","#711C00","#713900","#715500","#717100","#557100","#397100","#1C7100","#007100","#00711C","#007139","#007155","#007171","#005571","#003971","#001C71","#393971","#453971","#553971","#613971","#713971","#713961","#713955","#713945","#713939","#714539","#715539","#716139","#717139","#617139","#557139","#457139","#397139","#397145","#397155","#397161","#397171","#396171","#395571","#394571","#515171","#595171","#615171","#695171","#715171","#715169","#715161","#715159","#715151","#715951","#716151","#716951","#717151","#697151","#617151","#597151","#517151","#517159","#517161","#517169","#517171","#516971","#516171","#515971","#000041","#100041","#200041","#310041","#410041","#410031","#410020","#410010","#410000","#411000","#412000","#413100","#414100","#314100","#204100","#104100","#004100","#004110","#004120","#004131","#004141","#003141","#002041","#001041","#202041","#282041","#312041","#392041","#412041","#412039","#412031","#412028","#412020","#412820","#413120","#413920","#414120","#394120","#314120","#284120","#204120","#204128","#204131","#204139","#204141","#203941","#203141","#202841","#2D2D41","#312D41","#352D41","#3D2D41","#412D41","#412D3D","#412D35","#412D31","#412D2D","#41312D","#41352D","#413D2D","#41412D","#3D412D","#35412D","#31412D","#2D412D","#2D4131","#2D4135","#2D413D","#2D4141","#2D3D41","#2D3541","#2D3141","#000000","#000000","#000000","#000000","#000000","#000000","#000000"]}),Tt({color:7}),fe("pal",()=>K),fe("color",()=>pe),fe("palMap",()=>Ne),br(e)}function br(){y("setDefaultPal",It,!1,["pal"]),y("setDefaultColor",Tt,!1,["color"]),y("setColor",_r,!0,["color","isAddToPalette"]),y("getColor",yr,!0,["asIndex"]),y("getPal",Ir,!0,[]),y("setPal",Tr,!0,["pal"]),y("getPalIndex",Mr,!0,["color","tolerance"]),y("setBgColor",Nr,!0,["color"]),y("setContainerBgColor",Pr,!0,["color"]),y("setPalColor",Br,!0,["index","color"]),y("getPalColor",Or,!0,["index"])}function It(e){let t=e.pal;if(!Array.isArray(t)){let r=new TypeError("setDefaultPal: Parameter pal must be an array.");throw r.code="INVALID_PARAMETER",r}if(t.length===0){let r=new RangeError("setDefaultPal: Parameter pal must have at least one color value.");throw r.code="EMPTY_PALETTE",r}K=[G([0,0,0,0])];for(let r=0;r<t.length;r++){let o=G(t[r]);o===null?(console.warn(`setDefaultPal: Invalid color value inside array pal at index: ${r}.`),K.push(G("#000000"))):K.push(o)}Ne=new Map;for(let r=0;r<K.length;r++)Ne.set(K[r].key,r);Ne.has(pe.key)||(pe=K[1])}function Tt(e){let t=e.color;if(!isNaN(Number(t))&&K.length>t)pe=K[t];else{if(t=G(t),t===null){let r=new TypeError("setDefaultColor: Parameter color is not a valid color format.");throw r.code="INVALID_PARAMETER",r}pe=t}}function _r(e,t){let r=t.color,o=!!t.isAddToPalette,n;if(typeof r=="number"){if(r>=e.pal.length){let i=new TypeError("setColor: Parameter color index is not in pal.");throw i.code="INVALID_PARAMETER",i}n=e.pal[r]}else{if(n=G(r),n===null){let i=new TypeError("setColor: Parameter color is not a valid color format.");throw i.code="INVALID_PARAMETER",i}o&&Z(e,n)===null&&(e.pal.push(n),e.palMap.set(n.key,e.pal.length-1))}return He(n,e.color),!0}function yr(e,t){return t.asIndex?Z(e,e.color):$(e.color.r,e.color.g,e.color.b,e.color.a)}function Ir(e){let t=[];for(let r=1;r<e.pal.length;r+=1)t.push({...e.pal[r]});return t}function Tr(e,t){let r=t.pal;if(!Array.isArray(r)){let l=new TypeError("setPal: Parameter pal is must be an array.");throw l.code="INVALID_PARAMETER",l}if(r.length===0){let l=new RangeError("setPal: Parameter pal must have at least one color value.");throw l.code="EMPTY_PALETTE",l}let o=[G([0,0,0,0])];for(let l=0;l<r.length;l++){let s=G(r[l]);s===null?(console.warn(`setPal: Invalid color value inside array pal at index: ${l}.`),o.push(G("#000000"))):o.push(s)}e.pal=o,e.palMap=new Map;for(let l=0;l<o.length;l++)e.palMap.set(o[l].key,l);let n=e.color,i=Z(e,n);i!==null?e.color=o[i]:e.color=o[1]}function Mr(e,t){let r=t.color,o=Te(t.tolerance,1);if(o<0||o>1){let l=new RangeError("getPalIndex: Parameter tolerance must be a number between 0 and 1.");throw l.code="INVALID_PARAMETER",l}let n=G(r);if(n===null){let l=new TypeError("getPalIndex: Parameter color is not a valid color format.");throw l.code="INVALID_COLOR",l}let i=Z(e,n,o);return i===null?!1:i}function Nr(e,t){let r=t.color,o;if(Number.isInteger(r)?o=e.pal[r]:o=G(r),o&&typeof o.hex=="string")e.canvas.style.backgroundColor=o.hex;else{let n=new TypeError("setBgColor: invalid color value for parameter color.");throw n.code="INVALID_COLOR",n}}function Pr(e,t){let r=t.color,o;if(e.container)if(Number.isInteger(r)?o=e.pal[r]:o=G(r),o&&typeof o.hex=="string"){e.container.style.backgroundColor=o.hex;return}else{let n=new TypeError("setContainerBgColor: invalid color value for parameter color.");throw n.code="INVALID_COLOR",n}}function Br(e,t){let r=t.index,o=t.color;if(!Number.isInteger(r)||r<0||r>=e.pal.length){let l=new RangeError("setPalColor: Parameter index must be an integer value.");throw l.code="INVALID_INDEX",l}if(r===0){let l=new RangeError("setPalColor: Parameter index cannot be 0, this is reserved for transparency. To set background color of the screen use the setBgColor command.");throw l.code="INVALID_INDEX",l}let n=G(o);if(n===null){let l=new TypeError("setPalColor: Parameter color is not a valid color format.");throw l.code="INVALID_COLOR",l}let i=e.pal[r];e.color.key===i.key&&(e.color=n),e.pal[r]=n,e.palMap.delete(i.key),e.palMap.set(n.key,r)}function Or(e,t){let r=t.index;if(e.pal[r]){let o=e.pal[r];return $(o.r,o.g,o.b,o.a)}return null}function qe(e,t){let r;return Number.isInteger(t)?t>=e.pal.length?null:e.pal[t]:(r=G(t),r)}function Z(e,t,r=1){if(e.palMap.has(t.key))return e.palMap.get(t.key);let o=65025*3.25,n=r*(2-r)*o,i=null,l=0;for(let s=0;s<e.pal.length;s++){let a=e.pal[s];if(a.key===t.key)return s;let c;s===0?c=Me(a,t,[.2,.2,.2,.4]):c=Me(a,t);let u=o-c;u>=n&&u>l&&(i=s,l=u)}return i}function je(e,t){return t>=e.pal.length?null:e.pal[t]}var Mt=["pset","lines","arc","bezier"];function Nt(e,t,r,o,n,i,l,s,a,c,u){let d;t.renderMode===U?d=i:d=h=>a(h,c,u);let p=(h,_)=>{let f,T;if(o(h)?(f=n(h.x1,null),T=n(h.y1,null)):(f=n(h,null),T=n(_,null)),f===null||T===null){let I=new TypeError("pset: Parameters x and y must be integers.");throw I.code="INVALID_PARAMETER",I}d(t),r(t,f,T,l),s(t)};e.pset=p,t.api.pset=p;let g;t.renderMode===U?g=i:g=(h,_,f,T,I)=>{let M=T-_,N=I-f,E=Math.round(Math.sqrt(M*M+N*N))+1;a(h,c,E*u)};let m=(h,_,f,T)=>{let I,M,N,E;if(o(h)?(I=n(h.x1,null),M=n(h.y1,null),N=n(h.x2,null),E=n(h.y2,null)):(I=n(h,null),M=n(_,null),N=n(f,null),E=n(T,null)),I===null||M===null||N===null||E===null){let A=new TypeError("line: Parameters x1, y1, x2, and y2 must be integers.");throw A.code="INVALID_COORDINATES",A}g(t,I,M,N,E),Sr(t,I,M,N,E,l,r),s(t)};e.line=m,t.api.line=m;let x;t.renderMode===U?x=i:x=(h,_,f)=>{let T=Math.max(0,Math.min(360,f)),I=Math.max(1,Math.round(2*Math.PI*_*(T/360)));a(h,c,I*u)};let P=(h,_,f,T,I)=>{let M,N,E,A,v;if(o(h)?(M=n(h.x1,null),N=n(h.y1,null),E=n(h.radius,null),A=n(h.angle1,null),v=n(h.angle2,null)):(M=n(h,null),N=n(_,null),E=n(f,null),A=n(T,null),v=n(I,null)),M===null||N===null||E===null||A===null||v===null){let w=new TypeError("arc: Parameters x1, y1, radius, angle1, and angle2 must be integers.");throw w.code="INVALID_PARAMETERS",w}A=(A+360)%360,v=(v+360)%360;let S=A>v;if(E<0)return;if(E===0){x(t,1,0),r(t,M,N,l),s(t);return}let L;S?L=360-A+v:L=v-A,x(t,E,L),Lr(t,M,N,E,A,v,S,l,r),s(t)};e.arc=P,t.api.arc=P;let b;t.renderMode===U?b=i:b=(h,_,f,T,I,M,N,E,A)=>{let v=Math.hypot(T-_,I-f),S=Math.hypot(M-T,N-I),L=Math.hypot(E-M,A-N),w=Math.max(1,Math.round(v+S+L));a(h,c,w*u)};let B=(h,_,f,T,I,M,N,E)=>{let A,v,S,L,w,C,R,F;if(o(h)?(A=n(h.xStart,null),v=n(h.yStart,null),S=n(h.x1,null),L=n(h.y1,null),w=n(h.x2,null),C=n(h.y2,null),R=n(h.xEnd,null),F=n(h.yEnd,null)):(A=n(h,null),v=n(_,null),S=n(f,null),L=n(T,null),w=n(I,null),C=n(M,null),R=n(N,null),F=n(E,null)),A===null||v===null||S===null||L===null||w===null||C===null||R===null||F===null){let O=new TypeError("bezier: Parameters xStart, yStart, x1, y1, x2, y2, xEnd, and yEnd must be integers.");throw O.code="INVALID_PARAMETERS",O}b(t,A,v,S,L,w,C,R,F),Vr(t,A,v,S,L,w,C,R,F,l,r),s(t)};e.bezier=B,t.api.bezier=B}function Sr(e,t,r,o,n,i,l){let s=Math.abs(o-t),a=Math.abs(n-r),c=t<o?1:-1,u=r<n?1:-1,d=s-a;for(l(e,t,r,i);!(t===o&&r===n);){let p=d<<1;p>-a&&(d-=a,t+=c),p<s&&(d+=s,r+=u),l(e,t,r,i)}}function Lr(e,t,r,o,n,i,l,s,a){function c(g,m){let x=Math.atan2(m-r,g-t)*(180/Math.PI);x=(x+360)%360,l?(x>=n||x<=i)&&a(e,g,m,s):x>=n&&x<=i&&a(e,g,m,s)}let u=o,d=0,p=1-u;for(c(t+u,r+d),c(t-u,r+d),c(t+d,r+u),c(t+d,r-u);u>=d;)d++,p<0?p+=2*d+1:(u--,p+=2*(d-u)+1),c(t+u,r+d),c(t+d,r+u),c(t-d,r+u),c(t-u,r+d),c(t-u,r-d),c(t-d,r-u),c(t+d,r-u),c(t+u,r-d)}function Vr(e,t,r,o,n,i,l,s,a,c,u){function d(B){let h=1-B,_=h*h,f=_*h,T=B*B,I=T*B,M=Math.round(f*t+3*_*B*o+3*h*T*i+I*s),N=Math.round(f*r+3*_*B*n+3*h*T*l+I*a);return{x:M,y:N}}function p(B,h){let _=B.x-h.x,f=B.y-h.y;return Math.sqrt(_*_+f*f)}let g=d(0);u(e,g.x,g.y,c);let m=.1,x=.1,P=1;for(;m<1;){let B=d(m);p(B,g)>P&&x>1e-5?(m-=x,x=x*.75):(u(e,B.x,B.y,c),g=B),m+=x}let b=d(1);u(e,b.x,b.y,c)}var Pt=["rect","circle","ellipse"];function Bt(e,t,r,o,n,i,l,s,a,c,u,d,p,g,m,x,P){let b,B;t.renderMode===U?(b=l,B=l):(b=(E,A,v)=>{let S=A*2+v*2;c(E,u,S*d)},B=(E,A,v)=>{let S=A*v;c(E,u,S*d)});let h=(E,A,v,S,L)=>{let w,C,R,F,O;if(n(E)?(w=i(E.x1,null),C=i(E.y1,null),F=i(E.width,null),O=i(E.height,null),R=E.pFillColor):(w=i(E,null),C=i(A,null),F=i(v,null),O=i(S,null),R=L),w===null||C===null||F===null||O===null){let Rt=new TypeError("rect: Parameters x1, y1, width, and height must be integers.");throw Rt.code="INVALID_COORDINATES",Rt}if(F<1||O<1)return;let oe=w+F,k=C+O,se=P(t,R);se!==null&&F>m&&O>m&&(B(t,F,O),Gr(t,Math.max(w+x,0),Math.max(C+x,0),Math.min(oe-x,p-1),Math.min(k-x,g-1),se,o)),b(t,F,O),kr(t,w,C,oe,k,s,r),a(t)};e.rect=h,t.api.rect=h;let _,f;t.renderMode===U?(_=l,f=l):(_=(E,A)=>{let v=Math.round(2*Math.PI*A);c(E,u,v*d)},f=(E,A)=>{let v=Math.round(Math.PI*A*A);c(E,u,v*d)});let T=(E,A,v,S)=>{let L,w,C,R;if(n(E)?(L=i(E.x1,null),w=i(E.y1,null),C=i(E.radius,null),R=E.pFillColor):(L=i(E,null),w=i(A,null),C=i(v,null),R=S),L===null||w===null||C===null){let O=new TypeError("circle: Parameters x1, y1, and radius must be integers.");throw O.code="INVALID_COORDINATES",O}if(C<0)return;if(C===0){B(t,1,1),r(t,L,w,s),a(t);return}let F=P(t,R);F!==null&&C>m&&(f(t,C),Yr(t,L,w,C,F,o,p-1,g-1)),_(t,C),zr(t,L,w,C,s,r),a(t)};e.circle=T,t.api.circle=T;let I,M;t.renderMode===U?(I=l,M=l):(I=(E,A,v)=>{let S=Math.round(2*Math.PI*Math.sqrt((A*A+v*v)/2));c(E,u,S*d)},M=(E,A,v)=>{let S=Math.round(Math.PI*A*v);c(E,u,S*d)});let N=(E,A,v,S,L)=>{let w,C,R,F,O;if(n(E)?(w=i(E.x1,null),C=i(E.y1,null),R=i(E.rx,null),F=i(E.ry,null),O=E.pFillColor):(w=i(E,null),C=i(A,null),R=i(v,null),F=i(S,null),O=L),w===null||C===null||R===null||F===null){let k=new TypeError("ellipse: Parameters x1, y1, rx, and ry must be integers.");throw k.code="INVALID_COORDINATES",k}if(R<0||F<0)return;if(R===0&&F===0){I(t,1,1),r(t,w,C,s),a(t);return}if(R===0){I(t,1,F);let k=C-F,se=C+F;for(;k<=se;)r(t,w,k,s),k++;a(t);return}if(F===0){I(t,R,1);let k=w-R,se=w+R;for(;k<=se;)r(t,k,C,s),k++;a(t);return}let oe=P(t,O);oe!==null&&R>m&&F>m&&(M(t,R,F),Wr(t,w,C,R,F,oe,o,p-1,g-1)),I(t,R,F),Xr(t,w,C,R,F,s,r),a(t)};e.ellipse=N,t.api.ellipse=N}function kr(e,t,r,o,n,i,l){if(t===o&&r===n){l(e,t,r,i);return}if(r===n){let c=t;for(;c<=o;)l(e,c,r,i),c++;return}if(t===o){let c=r;for(;c<=n;)l(e,t,c,i),c++;return}let s,a;for(s=t;s<=o;)l(e,s,r,i),s++;for(s=t;s<=o;)l(e,s,n,i),s++;for(a=r+1;a<n;)l(e,t,a,i),l(e,o,a,i),a++}function Gr(e,t,r,o,n,i,l){let s=r;for(;s<=n;){let a=t;for(;a<=o;)l(e,a,s,i),a++;s++}}function zr(e,t,r,o,n,i){let l=o,s=0,a=1-l;for(;l>=s;)i(e,t+l,r+s,n),i(e,t+s,r+l,n),i(e,t-s,r+l,n),i(e,t-l,r+s,n),i(e,t-l,r-s,n),i(e,t-s,r-l,n),i(e,t+s,r-l,n),i(e,t+l,r-s,n),s++,a<0?a+=2*s+1:(l--,a+=2*(s-l)+1)}function Yr(e,t,r,o,n,i,l,s){for(let a=-o;a<=o;a++){let c=r+a;if(c<0||c>s)continue;let u=Math.floor(Math.sqrt(o*o-a*a)),d=Math.max(t-u,0),p=Math.min(t+u,l);for(;d<=p;)i(e,d,c,n),d++}}function Xr(e,t,r,o,n,i,l){let s=0,a=n,c=o*o,u=n*n,d=2*u*s,p=2*c*a,g=u-c*n+.25*c;for(;d<p;)l(e,t+s,r+a,i),l(e,t-s,r+a,i),l(e,t-s,r-a,i),l(e,t+s,r-a,i),s++,d+=2*u,g<0?g+=u+d:(a--,p-=2*c,g+=u+d-p);let m=u*(s+.5)*(s+.5)+c*(a-1)*(a-1)-c*u;for(;a>=0;)l(e,t+s,r+a,i),l(e,t-s,r+a,i),l(e,t-s,r-a,i),l(e,t+s,r-a,i),a--,p-=2*c,m>0?m+=c-p:(s++,d+=2*u,m+=c-p+d)}function Wr(e,t,r,o,n,i,l,s,a){for(let c=-n;c<=n;c++){let u=r+c;if(u<0||u>a)continue;let d=1-c*c/(n*n),p=d<=0?0:Math.floor(o*Math.sqrt(d)),g=Math.max(t-p,0),m=Math.min(t+p,s);for(;g<=m;)l(e,g,u,i),g++}}var me=null;function Hr(e){me=e,Pe(null)}function Pe(e){if(e===null){for(let P of Mt)me[P]=()=>_e(P);for(let P of Pt)me[P]=()=>_e(P);return}let t=e.pens.penFn,r=e.pens.size,o=Math.round(r/2),n=e.width,i=e.height,l=e.blends.blendFn,s=e.renderer.setImageDirty,a=e.renderer.getImageData,c=Q,u=e.pens.pixelsPerPen,d=e.renderer.prepareBatch,p=ue,g=V,m=e.color,x=qe;Nt(me,e,t,p,g,a,m,s,d,c,u),Bt(me,e,t,l,p,g,a,m,s,d,c,u,n,i,r,o,x)}var ee="pixel",Se="square",Le="circle",Ze=new Set([ee,Se,Le]),le="replace",Je="alpha",Qe=new Set([le,Je]),qr={r:0,g:0,b:0,a:0};async function jr(e){Kr(),Zr()}function Kr(){Oe("blends",{blend:le,blendFn:null,noise:null,noiseData:[]}),Oe("pens",{pen:ee,penFn:null,size:1,pixelsPerPen:1}),De(e=>{Ot(e)})}function Zr(){y("setPen",Qr,!0,["pen","size","blend","noise"])}function Ot(e){let t=e.renderer.drawPixelUnsafe,r=e.renderer.blendPixelUnsafe,o=e.width,n=e.height,i=e.blends.noise,l=ye,s;if(e.blends.noise===null&&(e.renderMode===ie||e.blends.blend===le)?s=t:e.blends.blend===le?s=(a,c,u,d)=>{t(a,c,u,Ke(i,d,l))}:e.blends.blend===Je&&e.blends.noise===null?e.renderMode===ie?s=t:s=r:e.renderMode===ie?s=(a,c,u,d)=>{t(a,c,u,Ke(i,d,l))}:s=(a,c,u,d)=>{r(a,c,u,Ke(i,d,l))},e.pens.pen===ee)e.pens.penFn=(a,c,u,d)=>{c<0||c>=o||u<0||u>=n||s(a,c,u,d)};else if(e.pens.pen===Se){let a=e.pens.size|1,c=Math.round(a/2)-1;e.pens.penFn=(u,d,p,g)=>{let m=l(d-c,0,o),x=l(d-c+a,0,o),P=l(p-c,0,n),b=l(p-c+a,0,n);Jr(u,m,P,x,b,g,s)}}else if(e.pens.pen===Le)if(e.pens.size===2)e.pens.penFn=(a,c,u,d)=>{Dr(a,c,u,d,o,n,s)};else{let a=e.pens.size*2,c=e.pens.size,u=c-1,d=(c-.5)*(c-.5);e.pens.penFn=(p,g,m,x)=>{let P=l(g-u,0,o),b=l(g-u+a,0,o),B=l(m-u,0,n),h=l(m-u+a,0,n);eo(p,g,m,P,B,b,h,d,x,s)}}e.blends.blendFn=s,Pe(e)}function Qr(e,t){let r=t.pen,o=V(t.size,1),n=t.blend,i=t.noise;if(r||(r=e.pens.pen),!Ze.has(r)){let s=new TypeError(`setPen: Parameter pen is not a valid pen. Valid pens are (${Array.from(Ze).join(", ")}).`);throw s.code="INVALID_PEN",s}if(r===ee&&(o=1),o<1&&(o=1),o===1&&(r=ee),n||(n=e.blends.blend),!Qe.has(n)){let s=new TypeError(`setBlend: Parameter blend is not a valid blend. Valid blends are (${Array.from(Qe).join(", ")}).`);throw s.code="INVALID_BLEND_MODE",s}if(Array.isArray(i)){for(let s=0;s<i.length;s++)if(isNaN(i[s])){let a=new TypeError("setBlend: Parameter noise array contains an invalid value.");throw a.code="INVALID_NOISE_VALUE",a}}else i=V(i,null),i!==null&&(i=[i,i,i,0]);e.pens.pen=r,e.pens.size=o,r===Se?e.pens.pixelsPerPen=o*o:r===Le?o===2?e.pens.pixelsPerPen=5:e.pens.pixelsPerPen=Math.round(Math.PI*(o+1)*(o+1))+1:e.pens.pixelsPerPen=1;let l=e.blends.blend;e.blends.blend=n,e.blends.noise=i,Ot(e),l!==n&&e.renderMode===ie&&e.renderer.blendModeChanged(e,l)}function Jr(e,t,r,o,n,i,l){for(let s=r;s<n;s++)for(let a=t;a<o;a++)l(e,a,s,i)}function Dr(e,t,r,o,n,i,l){t>=0&&t<n&&r>=0&&r<i&&l(e,t,r,o),t+1>=0&&t+1<n&&r>=0&&r<i&&l(e,t+1,r,o),t-1>=0&&t-1<n&&r>=0&&r<i&&l(e,t-1,r,o),t>=0&&t<n&&r+1>=0&&r+1<i&&l(e,t,r+1,o),t>=0&&t<n&&r-1>=0&&r-1<i&&l(e,t,r-1,o)}function eo(e,t,r,o,n,i,l,s,a,c){for(let u=n;u<l;u++){let d=u-r;for(let p=o;p<i;p++){let g=p-t;g*g+d*d<s&&c(e,p,u,a)}}}function Ke(e,t,r){let o=qr;o.r=t.r,o.g=t.g,o.b=t.b,o.a=t.a;let n=e/2;return o.r=r(Math.round(o.r+ce(-e[0],e[0])),0,255),o.g=r(Math.round(o.g+ce(-e[1],e[1])),0,255),o.b=r(Math.round(o.b+ce(-e[2],e[2])),0,255),o.a=r(Math.round(o.a+ce(-e[3],e[3])),0,255),o}var St=`#version 300 es
in vec2 a_position;
in vec4 a_color;
uniform vec2 u_resolution;
out vec4 v_color;

void main() {

	// Convert screen coords to NDC with pixel center adjustment
	// Add 0.5 to center the pixel, then convert to NDC
	vec2 pixelCenter = a_position + 0.5;
	vec2 ndc = ((pixelCenter / u_resolution) * 2.0 - 1.0) * vec2(1.0, -1.0);
	gl_Position = vec4(ndc, 0.0, 1.0);
	gl_PointSize = 1.0;
	v_color = a_color;
}`;var Lt=`#version 300 es
precision mediump float;
in vec4 v_color;
out vec4 fragColor;

void main() {
	
	// The fragColor will always be the straight alpha v_color.
	// The blend state (enabled/disabled) will determine how it's written.
	fragColor = v_color;
}`;var Vt=`#version 300 es
in vec4 a_position;
in vec4 a_color;
in vec2 a_texCoord;

uniform vec2 u_resolution;

out vec4 v_color;
out vec2 v_texCoord;

void main() {
	
	// Convert from pixel space (0 to u_resolution) to clip space (-1 to 1)
	vec2 zeroToOne = a_position.xy / u_resolution;
	vec2 zeroToTwo = zeroToOne * 2.0;
	vec2 clipSpace = zeroToTwo - 1.0;

	// Flip the Y-coordinate to match standard 2D graphics (top-left origin)
	// In WebGL, +Y is typically up, but for 2D, we want +Y down.
	gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);

	v_color = a_color;
	v_texCoord = a_texCoord;
}`;var Ut=`#version 300 es
precision highp float;

in vec4 v_color;
in vec2 v_texCoord;

uniform sampler2D u_texture;

out vec4 outColor;

void main() {

	// Sample the color from the texture at the given texture coordinates
	vec4 texColor = texture(u_texture, v_texCoord);

	// Multiply the texture color by the vertex color (which can be used for tinting/alpha)
	// If v_color is white (1,1,1,1), it will just use the texColor.
	outColor = texColor * v_color;
}`;var kt=`#version 300 es
in vec2 a_position;
out vec2 v_texCoord;

void main() {
	gl_Position = vec4(a_position, 0.0, 1.0);

	// Flip Y coordinate when sampling texture
	v_texCoord = (a_position + 1.0) * 0.5;
}`;var Gt=`#version 300 es
precision mediump float;
in vec2 v_texCoord;
uniform sampler2D u_texture;
out vec4 fragColor;

void main() {
	vec4 texColor = texture(u_texture, v_texCoord);
	
	// The FBO already contains STRAIGHT ALPHA, so just output it directly.
	fragColor = texColor;
}`;var so=1e6,zt=5e3,ao=1e4,Yt=50,et=5e3,Ve=new Map,Q=0,X=1,uo=["POINTS","IMAGE"],co={type:null,program:null,vertices:null,colors:null,count:0,minCapacity:0,capacity:0,capacityChanged:!0,capacityLocalMax:0,capacityShrinkCheckTime:0,vertexComps:2,colorComps:4,texCoordComps:2,vertexVBO:null,colorVBO:null,texCoordVBO:null,vao:null,texture:null,image:null,mode:null,locations:null},Ee=!1;function fo(){it(tt),Ee=po()}function tt(e){if(e.renderMode===U)return;let t=e.gl;for(let r in e.batches){let o=e.batches[r];o.texCoordVBO&&t.deleteBuffer(o.texCoordVBO),t.deleteBuffer(o.vertexVBO),t.deleteBuffer(o.colorVBO),t.deleteVertexArray(o.vao),t.deleteProgram(o.program),o.texture&&t.deleteTexture(o.texture)}e.batches={},e.batchInfo={},e.displayProgram&&(t.deleteProgram(e.displayProgram),t.deleteBuffer(e.displayPositionBuffer)),e.FBO&&(t.deleteFramebuffer(e.FBO),t.deleteTexture(e.texture))}function po(){let e=document.createElement("canvas");e.width=1,e.height=1;let t={canvas:e,width:1,height:1},r=Ce(t);return r&&t.gl&&tt(t),r}function Ce(e){e.contextLost=!1,e.isRenderScheduled=!1,e.isFirstRender=!0,e.batches={},e.batchInfo={currentBatch:null,drawOrder:[]};let t=e.canvas,r=e.width,o=e.height;if(e.gl=t.getContext("webgl2",{alpha:!0,premultipliedAlpha:!1,antialias:!1,preserveDrawingBuffer:!0,desynchronized:!1,colorType:"unorm8"}),!e.gl)return!1;if(e.gl.viewport(0,0,r,o),!go(e))return e.gl=null,!1;if(e.batches[Q]=Wt(e,St,Lt,Q),e.batches[X]=Wt(e,Vt,Ut,X),mo(e),typeof window<"u"&&window.location.search.includes("webgl-debug")){let n=e.gl.getExtension("WEBGL_debug_renderer_info");n&&console.log("GPU:",e.gl.getParameter(n.UNMASKED_RENDERER_WEBGL))}return e.canvas.addEventListener("webglcontextlost",n=>{n.preventDefault(),console.warn("WebGL context lost"),e.contextLost=!0}),e.canvas.addEventListener("webglcontextrestored",()=>{console.log("WebGL context restored"),Ce(e),e.contextLost=!1,qt(e)}),!0}function go(e){let t=e.gl,r=e.width,o=e.height;if(e.texture=t.createTexture(),!e.texture)return console.error("Failed to create WebGL2 texture."),!1;t.bindTexture(t.TEXTURE_2D,e.texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA8,r,o,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),e.FBO=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,e.FBO),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e.texture,0);let n=t.checkFramebufferStatus(t.FRAMEBUFFER);return n!==t.FRAMEBUFFER_COMPLETE?(console.error("WebGL2 Framebuffer incomplete:",n),!1):(t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindTexture(t.TEXTURE_2D,null),!0)}function $t(e,t,r){let o=e.gl,n=Xt(e,o.VERTEX_SHADER,t),i=Xt(e,o.FRAGMENT_SHADER,r);if(!n||!i){let s=new Error("screen: Unable to compile shaders.");throw s.code="INVALID_SHADERS",s}let l=o.createProgram();if(o.attachShader(l,n),o.attachShader(l,i),o.linkProgram(l),o.deleteShader(n),o.deleteShader(i),!o.getProgramParameter(l,o.LINK_STATUS)){let s=o.getProgramInfoLog(l);o.deleteProgram(l);let a=new Error(`screen: Shader program error:, ${s}.`);throw a.code="SHADER_PROGRAM_ERROR",a}return l}function Xt(e,t,r){let o=e.gl,n=o.createShader(t);return o.shaderSource(n,r),o.compileShader(n),o.getShaderParameter(n,o.COMPILE_STATUS)?n:(console.error("Shader compile error:",o.getShaderInfoLog(n)),o.deleteShader(n),null)}function mo(e){let t=e.gl,r=$t(e,kt,Gt),o=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),n=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,o,t.STATIC_DRAW);let i=t.getAttribLocation(r,"a_position"),l=t.getUniformLocation(r,"u_texture");e.displayProgram=r,e.displayPositionBuffer=n,e.displayLocations={position:i,texture:l}}function Ht(e){e.isRenderScheduled||(e.isRenderScheduled=!0,ne(()=>{xe(e),Kt(e),e.isRenderScheduled=!1}))}function ho(e,t,r,o,n){}function qt(e,t){xe(e,t),Kt(e)}function Wt(e,t,r,o){let n=e.gl,i=Object.create(co);if(i.program=$t(e,t,r),i.locations={position:n.getAttribLocation(i.program,"a_position"),color:n.getAttribLocation(i.program,"a_color"),resolution:n.getUniformLocation(i.program,"u_resolution")},i.type=o,i.type===Q)i.capacity=zt,i.minCapacity=zt,i.maxCapacity=so,i.mode=n.POINTS;else if(i.type===X)i.capacity=Yt,i.minCapacity=Yt,i.maxCapacity=ao,i.mode=n.TRIANGLES,i.locations.texCoord=n.getAttribLocation(i.program,"a_texCoord"),i.locations.texture=n.getUniformLocation(i.program,"u_texture"),i.texCoords=new Float32Array(i.capacity*i.texCoordComps),i.texCoordVBO=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,i.texCoordVBO),n.enableVertexAttribArray(i.locations.texCoord),n.vertexAttribPointer(i.locations.texCoord,i.texCoordComps,n.FLOAT,!1,0,0);else throw new Error("Invalid batch type.");return i.vertices=new Float32Array(i.capacity*i.vertexComps),i.colors=new Uint8Array(i.capacity*i.colorComps),i.vertexVBO=n.createBuffer(),i.colorVBO=n.createBuffer(),i.vao=n.createVertexArray(),n.bindVertexArray(i.vao),n.bindBuffer(n.ARRAY_BUFFER,i.vertexVBO),n.enableVertexAttribArray(i.locations.position),n.vertexAttribPointer(i.locations.position,i.vertexComps,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,i.colorVBO),n.enableVertexAttribArray(i.locations.color),n.vertexAttribPointer(i.locations.color,i.colorComps,n.UNSIGNED_BYTE,!0,0,0),n.bindVertexArray(null),i.capacityShrinkCheckTime=Date.now()+et,i}function rt(e,t,r){let o=e.batches[t],n=e.batchInfo;if(n.currentBatch!==o){if(n.drawOrder.length>0){let s=n.drawOrder[n.drawOrder.length-1];s.endIndex=s.batch.count}let l={batch:o,startIndex:o.count,endIndex:null};o.type===X&&(l.image=o.image,l.texture=o.texture),n.drawOrder.push(l),n.currentBatch=o}let i=o.count+r;if(i>=o.capacity){if(i>o.maxCapacity)return xe(e),rt(e,t,r);let l=Math.max(i,o.capacity*2);jt(o,l)}return!0}function jt(e,t){let r=new Float32Array(t*e.vertexComps),o=new Uint8Array(t*e.colorComps);if(r.set(e.vertices),e.vertices=r,o.set(e.colors),e.colors=o,e.type===X){let n=new Float32Array(t*e.texCoordComps);n.set(e.texCoords),e.texCoords=n}console.log(`Batch ${uo[e.type]} resized from ${e.capacity} to ${t}`),e.capacity=t,e.capacityChanged=!0,e.capacityShrinkCheckTime=Date.now()+et}function xe(e,t=null){t===null&&(t=e.blends.blend);let r=e.gl;if(!e.contextLost){r.bindFramebuffer(r.FRAMEBUFFER,e.FBO),r.viewport(0,0,e.width,e.height),e.isFirstRender&&(r.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT),e.isFirstRender=!1),t===le?r.disable(r.BLEND):(r.enable(r.BLEND),r.blendFuncSeparate(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA));for(let o in e.batches){let n=e.batches[o];n.count>0&&Eo(r,n,e.width,e.height)}for(let o of e.batchInfo.drawOrder)if(o.endIndex===null&&(o.endIndex=o.batch.count),o.endIndex-o.startIndex>0){let n=o.batch.type===X?o.texture:null;Co(r,o.batch,o.startIndex,o.endIndex,n)}for(let o in e.batches){let n=e.batches[o];xo(n)}e.batchInfo.drawOrder=[],e.batchInfo.currentBatch=null,r.bindVertexArray(null),r.bindFramebuffer(r.FRAMEBUFFER,null)}}function Eo(e,t,r,o){e.useProgram(t.program),e.uniform2f(t.locations.resolution,r,o),e.bindVertexArray(t.vao),t.capacityChanged&&(e.bindBuffer(e.ARRAY_BUFFER,t.vertexVBO),e.bufferData(e.ARRAY_BUFFER,t.vertices.byteLength,e.STREAM_DRAW),e.bindBuffer(e.ARRAY_BUFFER,t.colorVBO),e.bufferData(e.ARRAY_BUFFER,t.colors.byteLength,e.STREAM_DRAW),t.type===X&&(e.bindBuffer(e.ARRAY_BUFFER,t.texCoordVBO),e.bufferData(e.ARRAY_BUFFER,t.texCoords.byteLength,e.STREAM_DRAW)),t.capacityChanged=!1),e.bindBuffer(e.ARRAY_BUFFER,t.vertexVBO),e.bufferSubData(e.ARRAY_BUFFER,0,t.vertices.subarray(0,t.count*t.vertexComps)),e.bindBuffer(e.ARRAY_BUFFER,t.colorVBO),e.bufferSubData(e.ARRAY_BUFFER,0,t.colors.subarray(0,t.count*t.colorComps)),t.type===X&&(e.bindBuffer(e.ARRAY_BUFFER,t.texCoordVBO),e.bufferSubData(e.ARRAY_BUFFER,0,t.texCoords.subarray(0,t.count*t.texCoordComps)))}function Co(e,t,r,o,n=null){e.useProgram(t.program),e.bindVertexArray(t.vao),t.type===X&&n&&(e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,n),e.uniform1i(t.locations.texture,0)),e.drawArrays(t.mode,r,o-r)}function xo(e){e.capacityLocalMax=Math.max(e.count,e.capacityLocalMax),e.count=0,e.type===X&&(e.image=null),Date.now()>e.capacityShrinkCheckTime&&(e.capacity>e.minCapacity&&e.capacityLocalMax<e.capacity*.5&&jt(e,Math.max(e.capacity*.5,e.minCapacity)),e.capacityShrinkCheckTime=Date.now()+et,e.capacityLocalMax=0)}function Kt(e){let t=e.gl,r=e.displayProgram,o=e.displayLocations;t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,e.canvas.width,e.canvas.height),t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT),t.disable(t.BLEND),t.useProgram(r),t.enableVertexAttribArray(o.position),t.bindBuffer(t.ARRAY_BUFFER,e.displayPositionBuffer),t.vertexAttribPointer(o.position,2,t.FLOAT,!1,0,0),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,e.texture),t.uniform1i(o.texture,0),t.drawArrays(t.TRIANGLES,0,6),t.disableVertexAttribArray(o.position)}function wo(e,t,r,o){let n=e.batches[Q],i=n.count*n.vertexComps,l=n.count*n.colorComps;n.vertices[i]=t,n.vertices[i+1]=r,n.colors[l]=o.r,n.colors[l+1]=o.g,n.colors[l+2]=o.b,n.colors[l+3]=o.a,n.count++}function Zt(e,t,r){xe(e);let o=e.gl,n=e.width,i=e.height;if(t<0||r<0||t>=n||r>=i)return null;let l=i-1-r,s=new Uint8Array(4);return o.bindFramebuffer(o.FRAMEBUFFER,e.FBO),o.readPixels(t,l,1,1,o.RGBA,o.UNSIGNED_BYTE,s),o.bindFramebuffer(o.FRAMEBUFFER,null),$(s[0],s[1],s[2],s[3])}function Ao(e,t,r){return new Promise(o=>{ne(()=>{o(Zt(e,t,r))})})}function Qt(e,t,r,o,n){let i=e.gl,l=e.width,s=e.height,a=Math.max(0,t),c=Math.max(0,r),u=Math.min(o,l-a),d=Math.min(n,s-c);if(u<=0||d<=0)return[];xe(e);let p=new Uint8Array(u*d*4),g=s-(c+d);i.bindFramebuffer(i.FRAMEBUFFER,e.FBO),i.readPixels(a,g,u,d,i.RGBA,i.UNSIGNED_BYTE,p),i.bindFramebuffer(i.FRAMEBUFFER,null);let m=new Array(d);for(let x=0;x<d;x++){let P=new Array(u);for(let b=0;b<u;b++){let B=d-1-x,h=(u*B+b)*4;P[b]=$(p[h],p[h+1],p[h+2],p[h+3])}m[x]=P}return m}function Fo(e,t,r,o,n){return new Promise(i=>{ne(()=>{i(Qt(e,t,r,o,n))})})}function Jt(e,t){if(!e.gl)return null;let r=Ve.get(t);r||(r=new Map,Ve.set(t,r));let o=e.gl,n=r.get(o);return n||(n=o.createTexture(),n?(o.bindTexture(o.TEXTURE_2D,n),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,t),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),o.bindTexture(o.TEXTURE_2D,null),r.set(o,n),n):(console.error("Failed to create WebGL2 texture for image."),null))}function ot(e){let t=Ve.get(e);if(!t)return;let r=nt();for(let o of r){if(!o.gl||o.renderMode!=="webgl2")continue;let n=t.get(o.gl);n&&(o.gl.deleteTexture(n),t.delete(o.gl))}t.size===0&&Ve.delete(e)}function Ro(e,t,r,o,n,i,l,s,a,c){let u=Jt(e,t);if(!u)return;let d=t.width,p=t.height,g=Math.round(d*i),m=Math.round(p*l),x=d*a,P=p*c,b=[{x:-g,y:-m},{x:x-g,y:-m},{x:-g,y:P-m},{x:x-g,y:P-m}],B=Math.cos(n),h=Math.sin(n);for(let F=0;F<b.length;F++){let O=b[F],oe=O.x*B-O.y*h,k=O.x*h+O.y*B;O.x=oe+r,O.y=k+o}let _=[0,0,1,0,0,1,1,0,1,1,0,1],f=e.batches[X],T=e.batchInfo;if(T.currentBatch===f&&(f.image!==t||f.texture!==u)){if(T.drawOrder.length>0){let O=T.drawOrder[T.drawOrder.length-1];O.endIndex=f.count}let F={batch:f,startIndex:f.count,endIndex:null,image:t,texture:u};T.drawOrder.push(F)}if(rt(e,X,6),f.image=t,f.texture=u,T.drawOrder.length>0){let F=T.drawOrder[T.drawOrder.length-1];F.endIndex===null&&(F.image=t,F.texture=u)}let I=Math.round(255),M=Math.round(255),N=Math.round(255),E=Math.round(s),A=f.count,v=A*f.vertexComps,S=A*f.colorComps,L=A*f.texCoordComps,w=v,C=S,R=L;f.vertices[w++]=b[0].x,f.vertices[w++]=b[0].y,f.colors[C++]=I,f.colors[C++]=M,f.colors[C++]=N,f.colors[C++]=E,f.texCoords[R++]=_[0],f.texCoords[R++]=_[1],f.vertices[w++]=b[1].x,f.vertices[w++]=b[1].y,f.colors[C++]=I,f.colors[C++]=M,f.colors[C++]=N,f.colors[C++]=E,f.texCoords[R++]=_[2],f.texCoords[R++]=_[3],f.vertices[w++]=b[2].x,f.vertices[w++]=b[2].y,f.colors[C++]=I,f.colors[C++]=M,f.colors[C++]=N,f.colors[C++]=E,f.texCoords[R++]=_[4],f.texCoords[R++]=_[5],f.vertices[w++]=b[1].x,f.vertices[w++]=b[1].y,f.colors[C++]=I,f.colors[C++]=M,f.colors[C++]=N,f.colors[C++]=E,f.texCoords[R++]=_[6],f.texCoords[R++]=_[7],f.vertices[w++]=b[3].x,f.vertices[w++]=b[3].y,f.colors[C++]=I,f.colors[C++]=M,f.colors[C++]=N,f.colors[C++]=E,f.texCoords[R++]=_[8],f.texCoords[R++]=_[9],f.vertices[w++]=b[2].x,f.vertices[w++]=b[2].y,f.colors[C++]=I,f.colors[C++]=M,f.colors[C++]=N,f.colors[C++]=E,f.texCoords[R++]=_[10],f.texCoords[R++]=_[11],f.count+=6,Ht(e)}var we={};W(we,{afterResize:()=>ut,beforeResize:()=>at,blendPixelUnsafe:()=>To,cleanup:()=>bo,cls:()=>yo,drawImage:()=>Po,drawPixelUnsafe:()=>Io,getImageData:()=>_o,init:()=>vo,initCanvas2D:()=>st,readPixel:()=>er,readPixelAsync:()=>Mo,readPixels:()=>tr,readPixelsAsync:()=>No,setImageDirty:()=>Dt});var lt=!1;function vo(e){}function bo(e){e.context=null,e.canvas=null,e.imageData=null,e.bufferCanvas=null,e.bufferContext=null}function st(e){let t=e.canvas.getContext("2d",{willReadFrequently:!0});return t?(t.imageSmoothingEnabled=!1,e.imageData=t.createImageData(e.width,e.height),e.context=t,e.bufferCanvas=null,e.bufferContext=null,!0):null}function _o(e){}function Dt(e){lt||(lt=!0,ne(()=>{e.context.putImageData(e.imageData,0,0),lt=!1}))}function at(e,t){e.bufferCanvas===null&&(e.bufferCanvas=new OffscreenCanvas(t.width,t.height),e.bufferContext=e.bufferCanvas.getContext("2d"),setTimeout(()=>{e.bufferCanvas=null,e.bufferContext=null},3e3)),e.bufferContext.clearRect(0,0,t.width,t.height),e.bufferContext.drawImage(e.canvas,0,0)}function ut(e,t,r){e.context.drawImage(e.bufferCanvas,0,0,t.width,t.height),e.bufferCanvas.width=r.width,e.bufferCanvas.height=r.height}function yo(e,t,r,o,n){}function Io(e,t,r,o){let n=e.imageData.data,i=(e.width*r+t)*4;n[i]=o.r,n[i+1]=o.g,n[i+2]=o.b,n[i+3]=o.a}function To(e,t,r,o){let n=e.imageData.data,i=(e.width*r+t)*4,l=o.a/255,s=n[i+3]/255;n[i]=Math.round(o.r*l+n[i]*(1-l)),n[i+1]=Math.round(o.g*l+n[i+1]*(1-l)),n[i+2]=Math.round(o.b*l+n[i+2]*(1-l)),n[i+3]=Math.round((l+s*(1-l))*255)}function er(e,t,r){if(t<0||r<0||t>=e.width||r>=e.height)return null;let o=e.imageData.data,n=(e.width*r+t)*4;return $(o[n],o[n+1],o[n+2],o[n+3])}function Mo(e,t,r){return Promise.resolve(er(e,t,r))}function tr(e,t,r,o,n){let i=e.width,l=e.height,s=e.imageData.data,a=new Array(n);for(let c=0;c<n;c++){let u=r+c,d=u>=0&&u<l,p=new Array(o);for(let g=0;g<o;g++){let m=t+g;if(d&&m>=0&&m<i){let x=(i*u+m)*4;p[g]=$(s[x],s[x+1],s[x+2],s[x+3])}else p[g]=null}a[c]=p}return a}function No(e,t,r,o,n){return Promise.resolve(tr(e,t,r,o,n))}function Po(e,t,r,o,n,i,l,s,a,c){let u=e.context,d=Math.round(t.width*i),p=Math.round(t.height*l);u.save(),u.globalAlpha=s/255,u.translate(r,o),u.rotate(n),u.scale(a,c),u.drawImage(t,-d,-p),u.restore(),Dt(e)}var ie="webgl2",U="canvas2d",J=8192,Bo={screen:!0},z={},ct={},dt=[],nr=[],ir=[],lr=[],rr=0,te=null,Ue=null,ke=new Set;function nt(){let e=[];for(let t in z)e.push(z[t]);return e}function Oo(e){Ue=new ResizeObserver(t=>{for(let r of t){let n=r.target.querySelectorAll("canvas[data-screen-id]");if(n.length!==0)for(let i of n){let l=parseInt(i.dataset.screenId,10),s=z[l];s&&ft(s,!1)}}}),So()}function So(){y("screen",Lo,!1,["aspect","container","isOffscreen","isNoStyles","resizeCallback","useCanvas2d"]),y("setScreen",Xo,!1,["screen"]),y("getScreen",Wo,!1,["screenId"]),y("removeScreen",Yo,!1,["screenId"]),y("width",$o,!0,[]),y("height",Ho,!0,[]),y("canvas",qo,!0,[])}function Oe(e,t){ct[e]=t}function fe(e,t){dt.push({name:e,fn:t})}function Ae(e){nr.push(e)}function De(e){ir.push(e)}function it(e){lr.push(e)}function de(e,t){if(te===null&&!t){let r=new Error(e+": You are attempting to call a method that requires a screen but there there is currently no active screen. Call $.screen() before calling any graphics commands.");throw r.code="NO_ACTIVE_SCREEN",r}return te}function Lo(e){if(e.resizeCallback!=null&&!H(e.resizeCallback)){let r=new TypeError("screen: Parameter resizeCallback must be a function.");throw r.code="INVALID_CALLBACK",r}let t={id:rr,useCanvas2d:!!e.useCanvas2d,isOffscreen:!!e.isOffscreen,isNoStyles:!!e.isNoStyles,resizeCallback:e.resizeCallback,api:Object.create(Bo),canvas:null,width:null,height:null,container:null,aspectData:null,clientRect:null,previousOffsetSize:null};Ee||(t.useCanvas2d=!0),Object.assign(t,structuredClone(ct));for(let r of dt)t[r.name]=structuredClone(r.fn());if(rr+=1,e.aspect||(t.aspectData={width:null,height:null,splitter:"",isFixedSize:!1}),typeof e.aspect=="string"&&e.aspect!==""){if(t.aspectData=Vo(e.aspect.toLowerCase()),!t.aspectData){let r=new Error("screen: Parameter aspect is not valid.");throw r.code="INVALID_ASPECT",r}t.aspectData.splitter!==":"&&zo(t.aspectData.width,t.aspectData.height)}if(Ee||(t.useCanvas2d=!0),t.canvas=document.createElement("canvas"),t.isOffscreen){if(!t.aspectData){let r=new Error("screen: You must supply an aspect ratio with exact dimensions for offscreen screens.");throw r.code="NO_ASPECT_OFFSCREEN",r}if(t.aspectData.splitter!=="x"){let r=new Error("screen: You must use aspect ratio with e(x)act pixel dimensions for offscreen screens. For example: 320x200 for width of 320 and height of 200 pixels.");throw r.code="INVALID_OFFSCREEN_ASPECT",r}Uo(t)}else{if(t.canvas.tabIndex=0,typeof e.container=="string"?t.container=document.getElementById(e.container):e.container?t.container=e.container:t.container=document.body,!We(t.container)){let r=new TypeError("screen: Invalid argument container. Container must be a DOM element or a string id of a DOM element.");throw r.code="INVALID_CONTAINER",r}t.isNoStyles||ko(t),t.container.appendChild(t.canvas),Ue&&t.container&&!ke.has(t.container)&&(Ue.observe(t.container),ke.add(t.container))}t.isOffscreen||ft(t,!0),te=t,z[t.id]=t,Go(t);for(let r of nr)r(t);return t.api.setPen(ee),t.api}function Vo(e){let t=e.replaceAll(" ","").match(/^(\d+(?:\.\d+)?)(:|x|e|m)(\d+(?:\.\d+)?)$/);if(!t)return null;let r=Number(t[1]),o=t[2],n=Number(t[3]);return isNaN(r)||r===0||isNaN(n)||n===0?null:{width:r,height:n,splitter:o,isFixedSize:o==="m"||o==="x"}}function Uo(e){e.canvas.width=e.aspectData.width,e.canvas.height=e.aspectData.height,e.container=null,e.isOffscreen=!0,e.isNoStyles=!1,e.resizeCallback=null,e.previousOffsetSize=null}function ko(e){e.canvas.style.outline="none",e.canvas.style.backgroundColor="black",e.canvas.style.position="absolute",e.canvas.style.imageRendering="pixelated";let t=["pixelated","crisp-edges","-webkit-crisp-edges"];for(let r=1;r<t&&e.canvas.styles.imageRendering!==t[r-1];r+=1)e.canvas.style.imageRendering=t[r];e.container===document.body&&(document.documentElement.style.height="100%",document.documentElement.style.margin="0",document.body.style.height="100%",document.body.style.margin="0",document.body.style.overflow="hidden",e.canvas.style.left="0",e.canvas.style.top="0")}function Go(e){let t=null;if(e.useCanvas2d||(t=Ce(e),t||(console.error("Failed to create WebGL 2 canvas, falling back to canvas2d renderer"),e.useCanvas2d=!0,e.aspect!==":"&&ft(e,!0))),t!==null)e.renderMode=ie,e.renderer=D;else{if(!st(e)){let o=new Error("screen: Failed to create rendering context.");throw o.code="NO_RENDERING_CONTEXT",o}e.renderMode=U,e.renderer=we}}function zo(e,t){if(e<=0||t<=0){let r=new Error("screen: Canvas dimensions must be positive.");throw r.code="INVALID_DIMENSIONS",r}if(e>J||t>J){let r=new Error(`screen: Canvas dimensions exceed maximum of ${J}px.`);throw r.code="DIMENSION_TOO_LARGE",r}}function Yo(e){let t=e.id;if(!z[t])return;let r=z[t];r.api.cancelInput(),r.api.clearEvents(),r.renderer.cleanup(r);for(let n of lr)n(r);let o=(n,i)=>{r.api[n]=()=>{let l=`Cannot call ${n}() on removed screen (id: ${i}). The screen has been removed from the page.`,s=new TypeError(l);throw s.code="DELETED_METHOD",s}};for(let n in r.api)typeof r.api[n]=="function"&&o(n,t);if(r.canvas&&r.canvas.parentElement&&r.canvas.parentElement.removeChild(r.canvas),r.container&&ke.has(r.container)){let n=!1;for(let i in z){let l=z[i];if(l!==r&&l.container===r.container){n=!0;break}}n||(Ue.unobserve(r.container),ke.delete(r.container))}r.canvas=null,r.commands=null,r.resizeCallback=null,r.container=null,r.aspectData=null,r.clientRect=null,r.previousOffsetSize=null;for(let n in ct)r[n]=null;for(let n of dt)r[n.name]=null;if(r===te){te=null;for(let n in z)if(z[n]!==r){te=z[n];break}}delete z[t]}function Xo(e){let t=e.screen,r;if(Number.isInteger(t)?r=t:t&&Number.isInteger(t.id)&&(r=t.id),!z[r]){let o=new Error("screen: Invalid screen.");throw o.code="INVALID_SCREEN",o}te=z[r]}function Wo(e){let t=V(e.screenId,null);if(t===null||t<0){let o=new Error("screen: Invalid screen id.");throw o.code="INVALID_SCREEN_ID",o}let r=z[t];if(!r){let o=new Error(`screen: Screen "${t}" not found.`);throw o.code="SCREEN_NOT_FOUND",o}return r.api}function $o(e){return e.width}function Ho(e){return e.height}function qo(e){return e.canvas}function ft(e,t){if(e.isOffscreen||e.isNoStyles||e.canvas.offsetParent===null)return;let r=e.previousOffsetSize;if(!t&&e.renderMode===U&&at(e,r),e.aspectData.splitter!==""){let n=or(e.container);jo(e,n.width,n.height)}else{e.container===document.body&&(e.canvas.style.position="static"),e.canvas.style.width="100%",e.canvas.style.height="100%";let n=or(e.canvas);e.canvas.width=Math.min(n.width,J),e.canvas.height=Math.min(n.height,J)}e.clientRect=e.canvas.getBoundingClientRect(),e.aspectData.isFixedSize?(e.width=e.aspectData.width,e.height=e.aspectData.height):(e.splitter===""||e.splitter===":")&&(e.width=newCssWidth,e.height=newCssHeight);let o={width:e.canvas.offsetWidth,height:e.canvas.offsetHeight};if(!t){e.renderMode===U&&ut(e,r,o);for(let n of ir)n(e)}e.resizeCallback&&r!==null&&(r.width!==o.width||r.height!==o.height)&&e.resizeCallback(e.api,r,o),e.previousOffsetSize=o}function jo(e,t,r){let o=e.aspectData,n=e.canvas,i=o.width,l=o.height,s=o.splitter,a,c;if(s==="m"||s==="e"){let u=Math.floor(t/i),d=Math.floor(r/l),p=u>d?d:u;p<1&&(p=1),a=i*p,c=l*p,s==="e"&&(i=Math.floor(t/p),l=Math.floor(r/p),a=i*p,c=l*p,e.width=i,e.height=l)}else{let u=l/i,d=i/l;a=r*d,c=t*u,a>t?(a=t,c=a*u):c=r}n.style.width=Math.floor(a)+"px",n.style.height=Math.floor(c)+"px",n.style.marginLeft=Math.floor((t-a)/2)+"px",n.style.marginTop=Math.floor((r-c)/2)+"px",s!==":"?(n.width=Math.min(i,J),n.height=Math.min(l,J)):(n.width=Math.min(Math.floor(a),J),n.height=Math.min(Math.floor(c),J))}function or(e){return{width:e.offsetWidth||e.clientWidth||e.width,height:e.offsetHeight||e.clientHeight||e.height}}var ze={},pt=[],Ye=!1,Fe=0,Ge=null,gt=[];function Ko(e){typeof document<"u"&&document.readyState==="loading"?document.addEventListener("DOMContentLoaded",en):Ye=!0,Zo(e),Ae(Jo)}function Zo(e){y("ready",Do,!1,["callback"]),y("set",sr,!0,["options"],!0)}function mt(){Fe++}function Xe(){Fe--,Fe<0&&(Fe=0),Et()}function Qo(e,t,r){ze[e]={fn:t,isScreen:r}}function y(e,t,r,o,n){if(gt.push({name:e,fn:t,isScreen:r,parameterNames:o,isScreenOptional:n}),e.startsWith("set")&&e!=="set"){let i=e.substring(3,4).toLowerCase()+e.substring(4);ze[i]={fn:t,isScreen:r,parameterNames:o}}}function ht(e){for(let t of gt){let{name:r,fn:o,isScreen:n,parameterNames:i,isScreenOptional:l}=t;n?e[r]=(...s)=>{let a=ae(s,i),c=de(r,l);return o(c,a)}:e[r]=(...s)=>{let a=ae(s,i);return o(a)}}}function Jo(e){for(let t of gt){let{name:r,fn:o,isScreen:n,parameterNames:i}=t;n&&(e.api[r]=(...l)=>{let s=ae(l,i);return o(e,s)})}}function Do(e){if(e!=null&&!H(e)){let t=new TypeError("ready: Parameter callback must be a function.");throw t.code="INVALID_CALLBACK",t}return new Promise(t=>{pt.push({callback:e,resolve:t,triggered:!1}),Et()})}function sr(e,t){for(let r in t)if(t[r]!==null&&ze[r]){let o=ze[r],i=[t[r]],l=ae(i,o.parameterNames);o.isScreen?o.fn(e,l):o.fn(l),r==="screen"&&(e=de())}}function en(){Ye=!0,Et()}function Et(){Ge!==null&&clearTimeout(Ge),Ge=setTimeout(tn,0)}function tn(){if(Ge=null,!Ye||Fe!==0)return;let e=pt.slice();pt=[];for(let t of e)t.triggered||(t.triggered=!0,t.callback&&t.callback(),t.resolve())}var xt={};W(xt,{init:()=>rn});var Ct=[],ar;function rn(e){ar=e,y("registerPlugin",on,!1,["name","version","description","init"]),y("getPlugins",nn,!1,[])}function on(e){if(!e.name||typeof e.name!="string"){let r=new TypeError("registerPlugin: Plugin must have a 'name' property.");throw r.code="INVALID_PLUGIN_NAME",r}if(!e.init||typeof e.init!="function"){let r=new TypeError(`registerPlugin: Plugin '${e.name}' must have an 'init' function.`);throw r.code="INVALID_PLUGIN_INIT",r}if(Ct.find(r=>r.name===e.name)){let r=new Error(`registerPlugin: Plugin '${e.name}' is already registered.`);throw r.code="DUPLICATE_PLUGIN",r}let t={name:e.name,version:e.version||"unknown",description:e.description||"",config:e,initialized:!1};Ct.push(t),ln(t)}function nn(){return Ct.map(e=>({name:e.name,version:e.version,description:e.description,initialized:e.initialized}))}function ln(e){if(!e.initialized)try{e.config.init(ar,m_mods),e.initialized=!0}catch(t){let r=new Error(`registerPlugin: Failed to initialize plugin '${e.name}': ${t.message}`);throw r.code="PLUGIN_INIT_FAILED",r.originalError=t,r}}var wt={};W(wt,{init:()=>sn});function sn(e){an(),e.put=(t,r,o,n)=>ur(de("put"),t,r,o,n),Ae(t=>{t.api.put=(r,o,n,i)=>ur(t,r,o,n,i)})}function an(){y("getPixel",un,!0,["x","y","asIndex"]),y("getPixelAsync",cn,!0,["x","y","asIndex"]),y("get",dn,!0,["x","y","width","height","tolerance","asIndex"])}function un(e,t){let r=V(t.x,null),o=V(t.y,null);if(r===null||o===null){let l=new TypeError("getPixel: Parameters x and y must be integers.");throw l.code="INVALID_PARAMETER",l}let n=t.asIndex===!0,i=e.renderer.readPixel(e,r,o);return n?Z(e,i):i}function cn(e,t){let r=V(t.x,null),o=V(t.y,null);if(r===null||o===null){let i=new TypeError("getPixelAsync: Parameters x and y must be integers.");throw i.code="INVALID_PARAMETER",i}let n=t.asIndex===!0;return e.renderer.readPixelsAsync(e,r,o).then(i=>{let l=i[0];return n?Z(e,l):l})}function dn(e,t){let r=V(t.x,null),o=V(t.y,null),n=V(t.width,null),i=V(t.height,null),l=t.tolerance,s=t.asIndex===null?!0:!!t.asIndex;if(r===null||o===null||n===null||i===null){let u=new TypeError("get: Parameters x, y, width and height must be integers.");throw u.code="INVALID_PARAMETER",u}if(n<=0||i<=0)return[];let a=e.renderer.readPixels(e,r,o,n,i);if(!s)return a;let c=new Array(a.length);for(let u=0;u<a.length;u++){let d=new Array(a[u].length);for(let p=0;p<n;p++){let g=a[u][p];if(s){let m=Z(e,g,l);d[p]=m===null?0:m}else d[p]=g}c[u]=d}return c}function ur(e,t,r,o,n=!1){let i,l,s,a;if(ue(t)?(i=t.data,l=V(t.x,null),s=V(t.y,null),a=!!t.include0):(i=t,l=V(r,null),s=V(o,null),a=!!n),!i||i.length<1)return null;if(l===null||s===null){let x=new TypeError("put: Parameters x and y must be integers.");throw x.code="INVALID_PARAMETER",x}let c=e.width,u=e.height,d=l<0?-l:0,p=s<0?-s:0,g=t[0]?t[0].length-d:0,m=t.length-p;if(l+d+g>c&&(g=c-l-d),s+p+m>u&&(m=u-s-p),!(g<=0||m<=0)){if(e.renderMode===U)e.renderer.getImageData();else{let x=0;for(let P=p;P<p+m;P++)i[P]&&(x+=g);e.renderer.prepareBatch(e,Q,x)}fn(e,i,l,s,a,p,d,g,m),e.renderer.setImageDirty(e)}}function fn(e,t,r,o,n,i,l,s,a){let c=i+a,u=l+s;for(let d=i;d<c;d++){let p=t[d];if(p)for(let g=l;g<u;g++){let m=~~p[g];if(m===0&&n===!1)continue;let x=je(e,m),P=r+g,b=o+d;e.renderer.drawPixelUnsafe(e,P,b,x)}}}var At={};W(At,{getCanvas2DImage:()=>En,getStoredImage:()=>pr,init:()=>pn,removeImage:()=>Cn});var re={},cr=0,fr=new WeakMap;function pn(e){gn()}function gn(){y("loadImage",mn,!1,["src","name","onLoad","onError"]),y("drawImage",hn,!0,["name","x","y","angle","anchorX","anchorY","alpha","scaleX","scaleY"])}function mn(e){let t=e.src,r=e.name,o=e.onLoad,n=e.onError,i="loadImage: Parameter src must be a string URL, Image element, or Canvas element.";if(typeof t=="string"){if(t===""){let s=new TypeError(i);throw s.code="INVALID_SRC",s}}else if(t&&typeof t=="object"){if(t.tagName!=="IMG"&&t.tagName!=="CANVAS"){let s=new TypeError(i);throw s.code="INVALID_SRC",s}}else{let s=new TypeError(i);throw s.code="INVALID_SRC",s}if(r&&typeof r!="string"){let s=new TypeError("loadImage: Parameter name must be a string.");throw s.code="INVALID_NAME",s}if((!r||r==="")&&(cr+=1,r=""+cr),re[r]){let s=new TypeError("loadImage: Parameter name must be unique.");throw s.code="INVALID_NAME",s}if(o!=null&&!H(o)){let s=new TypeError("loadImage: Parameter onLoad must be a function.");throw s.code="INVALID_CALLBACK",s}if(n!=null&&!H(n)){let s=new TypeError("loadImage: Parameter onError must be a function.");throw s.code="INVALID_CALLBACK",s}let l;return typeof t!="string"?(l=t,re[r]={status:"ready",type:"image",image:l,width:l.width,height:l.height},dr(l),o&&o(l),r):(re[r]={status:"loading"},l=new Image,mt(),l.onload=function(){re[r]={status:"ready",type:"image",image:l,width:l.width,height:l.height},dr(l),o&&o(l),Xe()},l.onerror=function(s){re[r]={status:"error",error:s},n&&n(s),Xe()},l.src=t,r)}function hn(e,t){let r=t.name,o=t.x||0,n=t.y||0,i=t.angle,l=t.anchorX,s=t.anchorY,a=t.alpha,c=t.scaleX,u=t.scaleY,d;if(typeof r=="string"){let g=pr(r);if(!g){let m=new Error(`drawImage: Image "${r}" not found.`);throw m.code="IMAGE_NOT_FOUND",m}if(g.status==="loading"){let m=new Error(`drawImage: Image "${r}" is still loading. Use $.ready() to wait for it.`);throw m.code="IMAGE_NOT_READY",m}if(g.status==="error"){let m=new Error(`drawImage: Image "${r}" failed to load.`);throw m.code="IMAGE_LOAD_FAILED",m}d=g.image}else if(r&&typeof r=="object")if(r.screen===!0){if(typeof r.canvas=="function"?d=r.canvas():d=r.canvas,!d){let g=new Error("drawImage: Screen has no canvas.");throw g.code="INVALID_SCREEN",g}}else if(r.tagName==="CANVAS"||r.tagName==="IMG")d=r;else{let g=new TypeError("drawImage: Parameter name must be a string, screen object, Canvas element, or Image element.");throw g.code="INVALID_NAME",g}else{let g=new TypeError("drawImage: Parameter name must be a string, screen object, Canvas element, or Image element.");throw g.code="INVALID_NAME",g}if(isNaN(o)||isNaN(n)){let g=new TypeError("drawImage: Parameters x and y must be numbers.");throw g.code="INVALID_COORDINATES",g}(c==null||isNaN(Number(c)))&&(c=1),(u==null||isNaN(Number(u)))&&(u=1),i==null&&(i=0),l==null&&(l=0),s==null&&(s=0),a==null&&a!==0&&(a=255);let p=$e(i);e.renderer.drawImage(e,d,o,n,p,l,s,a,c,u)}function dr(e){fr.set(e,e)}function En(e){return fr.get(e)||e}function pr(e){return typeof e!="string"?null:re[e]||null}function Cn(e){if(typeof e!="string")return;let t=re[e];if(t&&t.image){let r=t.image;ot(r),delete re[e]}}var Ft={};W(Ft,{init:()=>xn,offevent:()=>gr,onevent:()=>An,triggerEventListeners:()=>Fn});function xn(e){y("clearEvents",wn,!0,["clearEvents"],!0)}function wn(e,t){let r=t.type,o=Array.isArray(r)?r:r?[r]:null;if(!o){e&&void 0;return}for(let n of o){let i=n.toLowerCase();if(i==="keyboard");else if(i==="gamepad");else if(i==="mouse"){if(!e){let l=new Error("clearEvents: No screen available to clear mouse events.");throw l.code="NO_SCREEN",l}}else if(i==="touch"){if(!e){let l=new Error("clearEvents: No screen available to clear touch events.");throw l.code="NO_SCREEN",l}}else if(i==="press"){if(!e){let l=new Error("clearEvents: No screen available to clear press events.");throw l.code="NO_SCREEN",l}}else if(i==="click"){if(!e){let l=new Error("clearEvents: No screen available to clear click events.");throw l.code="NO_SCREEN",l}}else{let l=new Error(`clearEvents: Invalid type "${n}". Valid types: keyboard, mouse, touch, press, click, gamepad.`);throw l.code="INVALID_TYPE",l}}}function An(e,t,r,o,n,i,l,s,a,c){let u=!1;for(let d=0;d<n.length;d++)if(e===n[d]){u=!0;break}if(!u){let d=new Error(`${i}: mode needs to be one of the following: ${n.join(", ")}.`);throw d.code="INVALID_MODE",d}if(r=!!r,!H(t)){let d=new Error(`${i}: fn is not a valid function.`);throw d.code="INVALID_FUNCTION",d}if(o&&(!Number.isInteger(o.x)||!Number.isInteger(o.y)||!Number.isInteger(o.width)||!Number.isInteger(o.height))){let d=new Error(`${i}: hitBox must have properties x, y, width, and height whose values are integers.`);throw d.code="INVALID_HITBOX",d}return setTimeout(()=>{let d=t,p=e;typeof s=="string"&&(p=e+s);let g=t;r&&(g=(m,x)=>{gr(e,d,n,i,l,s),d(m,x)}),l[p]||(l[p]=[]),l[p].push({fn:g,hitBox:o,extraData:a,clickDown:!1,originalFn:d,customData:c})},1),!0}function gr(e,t,r,o,n,i){let l=!1;for(let a=0;a<r.length;a++)if(e===r[a]){l=!0;break}if(!l){let a=new Error(`${o}: mode needs to be one of the following: ${r.join(", ")}.`);throw a.code="INVALID_MODE",a}typeof i=="string"&&(e+=i);let s=t==null;if(!s&&!H(t)){let a=new Error(`${o}: fn is not a valid function.`);throw a.code="INVALID_FUNCTION",a}if(n[e]){if(s)delete n[e];else{for(let a=n[e].length-1;a>=0;a--)n[e][a].originalFn===t&&n[e].splice(a,1);n[e].length===0&&delete n[e]}return!0}return!1}function Fn(e,t,r,o){if(!r[e])return;let n=r[e].slice();for(let i=0;i<n.length;i++){let l=n[i];if(!(o==="up"&&!l.clickDown))if(l.hitBox){let s=!1,a;if(Array.isArray(t)){a=[];for(let c=0;c<t.length;c++){let u=t[c];Ie(u,l.hitBox)&&a.push(u)}a.length>0&&(s=!0)}else a=t,Ie(t,l.hitBox)&&(s=!0);s&&(o==="down"?l.clickDown=!0:(l.clickDown=!1,l.fn(a,l.customData)))}else l.fn(t,l.customData)}}var Rn="2.0.0-alpha.2",Re={version:Rn},vn=[Y,j,q,xt,D,we,he,ge,Be,wt,At,Ft];for(let e of vn)e.init&&e.init(Re);ht(Re);typeof window<"u"&&(window.pi=Re,window.$===void 0&&(window.$=Re));var zn=Re;export{zn as default,Re as pi};
/**
 * Pi.js - Main Entry Point
 * 
 * Graphics and sound library for retro-style games and demos.
 * 
 * @module pi.js
 * @author Andy Stubbs
 * @license Apache-2.0
 */
//# sourceMappingURL=pi.esm.min.js.map
