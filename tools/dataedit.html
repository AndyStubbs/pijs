<!DOCTYPE html>
<html>
	<head>
		<title>Data Edit</title>
		<script src="../build/pi-latest.js"></script>
		<style>
			html, body {
				background-color: black;
			}
			#data-text-container {
				display: none;
				position: absolute;
				width: 500px;
				height: 285px;
				left: calc( 50% - 250px);
				top: calc( 50% - 142.5px);
				z-index: 99;
				background-color: rgba(255,255,255,0.9);
				color: rgb(68, 68, 68);
				padding: 5px;
				border: 1px solid black;
			}
			#data-text-container textarea {
				display: block;
				width: calc( 100% - 5px );
				height: 225px;
				margin-bottom: 5px;
				resize: none;
			}
			#data-text-container input[type="button"] {
				margin-right: 15px;
				border-radius: 5px;
				padding: 5px;
				width: 100px;
				cursor: pointer;
				background-color: #77a;
				border: 1px solid #99e;
				color: #0d0d0d;
			}
			#data-text-container input[type="button"]:hover {
				background-color: #558;
			}
			.buttons {
				display: flex;
				justify-content: space-around;
			}
		</style>
	</head>
<body>

<div id="data-text-container">
	<label for="data-text">Data Value</label>
	<textarea id="data-text"></textarea>
	<div class="buttons">
		<input id="load-btn" type="button" value="Load" />
		<input id="copy-btn" type="button" value="Copy" />
		<input id="close-btn" type="button" value="Close" />
	</div>
</div>

<script>

"use strict";

let g_data = [];
let g_size = [ 30, 30 ];
let g_screen = null;
let g_colors = [ 15, 0 ];

// Close modal popup
document.getElementById( "close-btn" ).addEventListener( "click", () => {
	document.getElementById( "data-text-container" ).style.display = "none";
} );

// Setup Menu
$.ready( () => {
	g_screen = $.screen( { "aspect": "320x200", "willReadFrequently": true } );
	$.setFont( 2 );
	$.print( "Hello World" );
	$.setActionKey( "Control" );
	$.setActionKey( "m" );
	setupInput();
	show();
} );

function setupInput() {
	$.onkey( "Digit0", "down", showMenu );
	$.onkey( "Digit1", "down", setColor1 );
	$.onkey( "Digit2", "down", setColor2 );
	$.onkey( "Digit3", "down", setDataSize );
	$.onkey( "Digit4", "down", clearData );
	$.onkey( "Digit5", "down", showValues );
}

function removeInput() {
	$.offkey( "Digit0", "down", showMenu );
	$.offkey( "Digit1", "down", setColor1 );
	$.offkey( "Digit2", "down", setColor2 );
	$.offkey( "Digit3", "down", setDataSize );
	$.offkey( "Digit4", "down", clearData );
	$.offkey( "Digit5", "down", showValues );
}

function show( isSkipData ) {
	$.cls();
	$.setColor( "#fff" );
	$.setPos( 0, 0 );
	$.print( "0 - Menu", true );
	$.setColor( "#888" );
	$.line( 0, 10, 105, 10 );
	showActiveColors();
	if( !isSkipData ) {
		showData();
	}
}

function showMenu() {
	show( true );
	$.setColor( "#888" );
	$.setPos( 0, 2 );
	$.print( "0. See Menu" );
	$.print( "1. Set Color 1" );
	$.print( "2. Set Color 2" );
	$.print( "3. Set Data Size" );
	$.print( "4. Clear Data" );
}

function showValues() {
	document.getElementById( "data-text-container" ).style.display = "block";
}

function clearData() {
	g_data = [];
	for( let y = 0; y < g_size[ 1 ]; y += 1 ){
		g_data.push( [] );
		for( let x = 0; x < g_size[ 0 ]; x += 1 ) {
			g_data[ y ].push( 3 );
		}
	}
	show();
}

async function setDataSize() {
	console.log( "Setting data size" );
	removeInput();
	show( true );
	$.setColor( "#888" );
	$.setPos( 0, 2 );
	$.print( "Set Data Size" );
	g_size[ 0 ] = await $.input( "Enter width: ", null, true, true, false );
	g_size[ 1 ] = await $.input( "Enter height: ", null, true, true, false );
	setupInput();
	show();
}

function showData() {
	$.put( g_data, 200, 12 );
}

function showActiveColors() {
	$.setColor( "#555" );
	$.rect( 294, 0, 26, 14 );
	drawColorBox( 295, 1, 12, g_colors[ 0 ] );
	drawColorBox( 307, 1, 12, g_colors[ 1 ] );
	setShadeColor( g_colors[ 0 ] );
	$.setPosPx( 297, 3 );
	$.print( "1" );
	setShadeColor( g_colors[ 1 ] );
	$.setPosPx( 309, 3 );
	$.print( "2" );
}

function setColor1() {
	show();
	$.setPos( 0, 3 );
	$.print( "Set Color 1", true, true );
	showColors();
}

function setColor2() {
	show();
	$.setPos( 0, 3 );
	$.print( "Set Color 2", true, true );
	pickColor();
}

function pickColor() {
	$.setColor( "#fff" );
	$.rect( 25, 25, 250, 150 );
	let r = 0;
	let g = 0;
	let b = 0;
	for( let x = 25; x < 250; x += 1 ) {
		for( let y = 25; y < 150; y += 1 ) {
			$.setColor( [ r, g, b ] );
			$.pset( x, y );
			if( x % 3 === 0 ) {
				r += 1;
			} else if( x % 3 === 1 ) {
				g += 1;
			} else {
				b += 1;
			}
		}
	}
}

function showColors() {
	let offX = 25;
	let offY = 40;
	let row = 0;
	let col = 0;
	let size = 12;
	let cols = 20;
	let pixels = [ 0, 0 ];
	$.setColor( "#555" );
	$.rect( offX - 1, offY - 1, size * ( cols + 1 ) + 2, size * 12 + 2 );
	for( let c = 0; c < 252; c += 1 ) {
		drawColorBox( col + offX, row + offY, size, c );
		if( c === g_colors[ 0 ] ) {
			pixels[ 0 ] = [ col + offX, row + offY ];
		} else if( c === g_colors[ 1 ] ) {
			pixels[ 1 ] = [ col + offX, row + offY ];
		}
		col += size;
		if( col > size * cols ) {
			col = 0;
			row += size;
		}
	}

	// Show primary color
	setShadeColor( g_colors[ 0 ] );
	$.setPosPx( pixels[ 0 ][ 0 ] + 2, pixels[ 0 ][ 1 ] + 2 );
	$.print( 1 );

	// Show secondary color
	setShadeColor( g_colors[ 1 ] );
	$.setPosPx( pixels[ 1 ][ 0 ] + 2, pixels[ 1 ][ 1 ] + 2 );
	$.print( 2 );
}

function drawColorBox( x, y, size,c  ) {
	$.setColor( "#888" );
	$.rect( x, y, size, size );
	$.setColor( c );
	$.rect( x, y, size - 2, size - 2, c );
}

function setShadeColor( color ) {
	const val = $.getPal()[ color ];
	if( val.r + val.g + val.b > 128 ) {
		$.setColor( "#000" );
	} else {
		$.setColor( "#fff" );
	}
}

</script>
</body>
</html>
