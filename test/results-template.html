<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Pi.js Test Results</title>
	<style>
		body {
			font-family: monospace;
			background: #222;
			color: #fff;
			padding: 20px;
			margin: 0;
		}
		.page {
			max-width: 1000px;
			margin-left: auto;
			margin-right: auto;
		}
		h1 {
			color: #4CAF50;
		}
		.summary {
			background: #333;
			padding: 20px;
			border-radius: 5px;
			margin: 20px 0;
		}
		.summary h2 {
			margin-top: 0;
			color: #FFC107;
		}
		.stats {
			display: flex;
			gap: 20px;
			margin: 20px 0;
		}
		.stat {
			background: #1a1a1a;
			padding: 15px 25px;
			border-radius: 5px;
			text-align: center;
		}
		.stat-value {
			font-size: 32px;
			font-weight: bold;
		}
		.stat-passed { color: #4CAF50; }
		.stat-failed { color: #f44336; }
		.stat-skipped { color: #FFC107; }
		.test-list {
			background: #1a1a1a;
			padding: 15px;
			border-radius: 5px;
		}
		.test-list.collapsed {
			display: none;
		}
		.section-header {
			cursor: pointer;
			user-select: none;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}
		.section-header:hover {
			opacity: 0.8;
		}
		.toggle-icon {
			font-size: 20px;
			transition: transform 0.3s;
		}
		.toggle-icon.collapsed {
			transform: rotate(-90deg);
		}
		.view-diff-btn {
			background: #FFC107;
			color: #000;
			border: none;
			padding: 8px 16px;
			border-radius: 3px;
			cursor: pointer;
			font-family: monospace;
			font-weight: bold;
			margin-top: 10px;
		}
		.view-diff-btn:hover {
			background: #FFD54F;
		}
		.modal {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.95);
			z-index: 1000;
			overflow: auto;
		}
		.modal.visible {
			display: block;
		}
		.modal-content {
			position: relative;
			width: 100%;
			height: 100%;
			padding: 20px;
			box-sizing: border-box;
		}
		.modal-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 20px;
		}
		.modal-header h2 {
			color: #FFC107;
			margin: 0;
		}
		.close-btn {
			background: #f44336;
			color: #fff;
			border: none;
			padding: 10px 20px;
			border-radius: 3px;
			cursor: pointer;
			font-family: monospace;
			font-weight: bold;
			font-size: 16px;
		}
		.close-btn:hover {
			background: #d32f2f;
		}
		.reset-base-btn {
			background: #FFC107;
			color: #000;
			border: none;
			padding: 10px 20px;
			border-radius: 3px;
			cursor: pointer;
			font-family: monospace;
			font-weight: bold;
			font-size: 16px;
			margin-right: 10px;
		}
		.reset-base-btn:hover {
			background: #FFD54F;
		}
		.reset-base-btn:disabled {
			background: #666;
			color: #999;
			cursor: not-allowed;
		}
		.screenshots-modal {
			display: flex;
			gap: 20px;
			height: calc(100% - 80px);
			align-items: center;
		}
		.screenshot-container {
			flex: 1;
			text-align: center;
			height: 100%;
			display: flex;
			flex-direction: column;
		}
		.screenshot-container h3 {
			color: #FFC107;
			margin: 0 0 10px 0;
		}
		.screenshot-wrapper {
			flex: 1;
			display: flex;
			align-items: center;
			justify-content: center;
			background: #000;
			border: 2px solid #444;
			border-radius: 5px;
			overflow: hidden;
		}
		.screenshot-wrapper img {
			max-width: 100%;
			max-height: 100%;
			width: 100%;
			object-fit: contain;
			image-rendering: pixelated;
		}
		.screenshot-wrapper canvas {
			max-width: 100%;
			max-height: 100%;
			width: 100%;
			object-fit: contain;
			image-rendering: pixelated;
			display: none;
		}
		.screenshot-wrapper canvas.visible {
			display: block;
		}
		.test-item {
			padding: 12px;
			margin: 5px 0;
			background: #333;
			border-radius: 3px;
			display: grid;
			grid-template-columns: 1fr auto;
			gap: 15px;
			align-items: start;
		}
		.test-item.passed {
			border-left: 4px solid #4CAF50;
		}
		.test-item.failed {
			border-left: 4px solid #f44336;
		}
		.test-item.skipped {
			border-left: 4px solid #FFC107;
		}
		.test-content {
			display: grid;
			grid-template-columns: 1fr auto;
			gap: 15px;
			align-items: start;
			min-width: 0;
		}
		.test-info {
			min-width: 0;
		}
		.test-actions {
			display: flex;
			flex-direction: column;
			gap: 8px;
			align-items: flex-end;
		}
		.test-status {
			padding: 4px 12px;
			border-radius: 3px;
			font-weight: bold;
			white-space: nowrap;
		}
		.status-passed {
			background: #4CAF50;
			color: #000;
		}
		.status-failed {
			background: #f44336;
			color: #fff;
		}
		.status-skipped {
			background: #FFC107;
			color: #000;
		}
		.test-details {
			font-size: 0.9em;
			color: #888;
			margin-top: 5px;
		}
		.error-msg {
			color: #f44336;
			margin-top: 5px;
			font-size: 0.9em;
		}
		a {
			color: #0caafb;
			text-decoration: none;
			font-size: 14px;
		}
		a:hover {
			text-decoration: underline;
		}
	</style>
</head>
<body>
	<div class="page">
		<h1>Pi.js v2.0 Visual Regression Test Results</h1>
		
		<div class="summary">
			<h2>Test Summary</h2>
			<div class="stats">
				<div class="stat">
					<div class="stat-value">{{TOTAL}}</div>
					<div>Total Tests</div>
				</div>
				<div class="stat">
					<div class="stat-value stat-passed">{{PASSED}}</div>
					<div>Passed</div>
				</div>
				<div class="stat">
					<div class="stat-value stat-failed">{{FAILED}}</div>
					<div>Failed</div>
				</div>
				<div class="stat">
					<div class="stat-value stat-skipped">{{SKIPPED}}</div>
					<div>Skipped</div>
				</div>
				<div class="stat">
					<div class="stat-value" style="color: var(--pass-rate-color)">{{PASS_RATE}}%</div>
					<div>Pass Rate</div>
				</div>
			</div>

			<div>
				<a href="/test/playwright-report/" target="_blank">Playwright Report</a>
			</div>
		</div>
		{{FAILED_TESTS}}

		{{PASSED_TESTS}}

		{{SKIPPED_TESTS}}
	</div>
	<!-- Modal for screenshot comparison -->
	<div id="diffModal" class="modal">
		<div class="modal-content">
			<div class="modal-header">
				<h2 id="modalTitle">Screenshot Comparison</h2>
				<div>
					<button class="reset-base-btn" id="resetBaseBtn" onclick="resetBaseImage()">Reset Base Image</button>
					<button class="close-btn" onclick="closeModal()">Close (ESC)</button>
				</div>
			</div>
			<div class="screenshots-modal">
				<div class="screenshot-container">
					<h3>Reference</h3>
					<div class="screenshot-wrapper">
						<img id="modalRefImg" src="" alt="Reference">
					</div>
				</div>
				<div class="screenshot-container">
					<h3>Current</h3>
					<div class="screenshot-wrapper">
						<img id="modalNewImg" src="" alt="Current">
					</div>
				</div>
				<div class="screenshot-container">
					<h3>Difference</h3>
					<div class="screenshot-wrapper">
						<canvas id="modalDiffCanvas"></canvas>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal for new test approval -->
	<div id="newTestModal" class="modal">
		<div class="modal-content">
			<div class="modal-header">
				<h2 id="newTestModalTitle">New Test Screenshot</h2>
				<div>
					<button class="reset-base-btn" id="approveTestBtn" onclick="approveNewTest()">Approve & Set as Reference</button>
					<button class="close-btn" onclick="closeNewTestModal()">Close (ESC)</button>
				</div>
			</div>
			<div class="screenshots-modal">
				<div class="screenshot-container" style="max-width: 60%; margin: 0 auto;">
					<h3>New Test Screenshot</h3>
					<div class="screenshot-wrapper">
						<img id="newTestImg" src="" alt="New Test">
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		// Store current baseName for reset and approve operations
		let currentBaseName = null;
		let currentNewTestBaseName = null;
		
		// Check if new screenshots exist for failed tests on page load
		window.addEventListener( "DOMContentLoaded", function() {
			checkMissingScreenshots();
		} );
		
		async function checkMissingScreenshots() {
			const failedTests = document.querySelectorAll( ".test-item.failed" );
			let movedCount = 0;
			
			for( const testItem of failedTests ) {

				// Extract baseName from the View Comparison button
				const viewBtn = testItem.querySelector( ".view-diff-btn" );
				if( !viewBtn ) continue;
				
				const onclickAttr = viewBtn.getAttribute( "onclick" );
				const match = onclickAttr.match( /showDiffModal\([^,]+,\s*'([^']+)'/ );
				if( !match ) continue;
				
				const baseName = match[ 1 ];
				const newPath = `/test/tests/screenshots/new/${baseName}.png`;
				
				// Check if new screenshot exists
				try {
					const response = await fetch( newPath, { "method": "HEAD" } );
					if( response.status === 404 ) {

						// New screenshot doesn't exist - convert to skipped
						testItem.classList.remove( "failed" );
						testItem.classList.add( "skipped" );
						testItem.style.borderLeftColor = "#FFC107";
						
						// Update status badge
						const statusBadge = testItem.querySelector( ".test-status" );
						if( statusBadge ) {
							statusBadge.classList.remove( "status-failed" );
							statusBadge.classList.add( "status-skipped" );
							statusBadge.textContent = "SKIPPED";
						}
						
						// Update error message
						const errorMsg = testItem.querySelector( ".error-msg" );
						if( errorMsg ) {
							errorMsg.textContent = "Base image was reset - re-run tests";
							errorMsg.style.color = "#FFC107";
						}
						
						// Remove View Comparison button
						if( viewBtn ) {
							viewBtn.remove();
						}
						
						movedCount++;
					}
				} catch( err ) {
					console.error( `Error checking ${newPath}:`, err );
				}
			}
			
			// Update counts if any tests were moved
			if( movedCount > 0 ) {
				updateTestCounts( movedCount );
			}
			
			// Check skipped tests for approved tests
			await checkApprovedTests();
		}
		
		async function checkApprovedTests() {
			const skippedTests = document.querySelectorAll( ".test-item.skipped" );
			
			for( const testItem of skippedTests ) {

				// Extract baseName from the View & Approve button (if it exists)
				const viewBtn = testItem.querySelector( ".view-diff-btn" );
				if( !viewBtn ) continue;
				
				const onclickAttr = viewBtn.getAttribute( "onclick" );
				const match = onclickAttr.match( /showNewTestModal\([^,]+,\s*'([^']+)'/ );
				if( !match ) continue;
				
				const baseName = match[ 1 ];
				const basePath = `/test/tests/screenshots/${baseName}.png`;
				const newPath = `/test/tests/screenshots/new/${baseName}.png`;
				
				try {

					// Check both base and new paths
					const baseResponse = await fetch( basePath, { "method": "HEAD" } );
					const newResponse = await fetch( newPath, { "method": "HEAD" } );
					
					const baseExists = baseResponse.status === 200;
					const newExists = newResponse.status === 200;
					
					// If base exists but new doesn't = approved, waiting for re-run
					if( baseExists && !newExists ) {

						// Update error message
						const errorMsg = testItem.querySelector( ".error-msg" );
						if( errorMsg ) {
							errorMsg.textContent = "Base image set - re-run tests to validate";
							errorMsg.style.color = "#4CAF50";
						}
						
						// Remove View & Approve button
						viewBtn.remove();
					}
					
					// If neither exists = something went wrong
					if( !baseExists && !newExists ) {

						// Update error message
						const errorMsg = testItem.querySelector( ".error-msg" );
						if( errorMsg ) {
							errorMsg.textContent = "Screenshot missing - re-run tests";
							errorMsg.style.color = "#f44336";
						}
						
						// Remove View & Approve button
						viewBtn.remove();
					}
				} catch( err ) {
					console.error( `Error checking ${baseName}:`, err );
				}
			}
		}
		
		function updateTestCounts() {

			// Get all skipped tests that were just converted
			const convertedSkippedTests = [];
			document.querySelectorAll( ".test-item.skipped" ).forEach( test => {
				if( test.parentElement && test.parentElement.id === "list-failed" ) {
					convertedSkippedTests.push( test );
				}
			} );
			
			// Update failed count
			const failedList = document.getElementById( "list-failed" );
			if( failedList ) {
				const failedCount = failedList.querySelectorAll( ".test-item.failed" ).length;
				const failedHeader = failedList.previousElementSibling;
				if( failedHeader && failedHeader.querySelector( "h2" ) ) {
					const h2 = failedHeader.querySelector( "h2" );
					h2.textContent = `Failed Tests (${failedCount})`;
					
					// Hide section if no failed tests
					if( failedCount === 0 ) {
						failedList.closest( ".summary" ).style.display = "none";
					}
				}
				const failedStat = document.querySelector( ".stat-failed" );
				failedStat.textContent = failedCount;
			}
			
			// Handle skipped section
			let skippedList = document.getElementById( "list-skipped" );
			
			// Create skipped section if it doesn't exist
			if( !skippedList && convertedSkippedTests.length > 0 ) {
				const failSection = document.getElementById( "list-failed" ).closest( ".summary" );
				const skippedSection = document.createElement( "div" );
				skippedSection.className = "summary";
				skippedSection.innerHTML = `
					<div class="section-header" onclick="toggleSection('skipped')">
						<h2 style="color: #FFC107;">Skipped Tests (0)</h2>
						<span class="toggle-icon" id="toggle-skipped">▼</span>
					</div>
					<div class="test-list" id="list-skipped"></div>
				`;
				
				// Insert after failed section or at the end
				if( failSection.nextElementSibling ) {
					failSection.parentElement.insertBefore(
						skippedSection, failSection.nextElementSibling
					);
				} else {
					failSection.parentElement.appendChild( skippedSection );
				}
				
				skippedList = document.getElementById( "list-skipped" );
			}
			
			// Move converted tests to skipped section
			if( skippedList ) {
				convertedSkippedTests.forEach( test => {
					skippedList.appendChild( test );
				} );
				
				// Update skipped count
				const skippedCount = skippedList.querySelectorAll( ".test-item.skipped" ).length;
				const skippedHeader = skippedList.previousElementSibling;
				if( skippedHeader && skippedHeader.querySelector( "h2" ) ) {
					const h2 = skippedHeader.querySelector( "h2" );
					h2.textContent = `Skipped Tests (${skippedCount})`;
				}
				const skippedStat = document.querySelector( ".stat-skipped" );
				skippedStat.textContent = skippedCount;
			}
		}
		
		function toggleSection( section ) {
			const list = document.getElementById( "list-" + section );
			const icon = document.getElementById( "toggle-" + section );
			
			list.classList.toggle( "collapsed" );
			icon.classList.toggle( "collapsed" );
		}
		
		function showDiffModal( testName, baseName, refPath, newPath ) {

			// Store baseName for reset operation
			currentBaseName = baseName;
			const modal = document.getElementById( "diffModal" );
			const modalTitle = document.getElementById( "modalTitle" );
			const modalRefImg = document.getElementById( "modalRefImg" );
			const modalNewImg = document.getElementById( "modalNewImg" );
			const modalCanvas = document.getElementById( "modalDiffCanvas" );
			
			// Set title
			modalTitle.textContent = `Screenshot Comparison: ${testName}`;
			
			// Reset canvas
			modalCanvas.classList.remove( "visible" );
			modalCanvas.width = 0;
			modalCanvas.height = 0;
			
			// Set image sources
			modalRefImg.src = refPath;
			modalNewImg.src = newPath;
			
			// Show modal
			modal.classList.add( "visible" );
			
			// Generate diff after images load
			Promise.all( [
				new Promise( resolve => {
					if( modalRefImg.complete ) resolve();
					else modalRefImg.onload = resolve;
				} ),
				new Promise( resolve => {
					if( modalNewImg.complete ) resolve();
					else modalNewImg.onload = resolve;
				} )
			] ).then( () => {
				// Set canvas size to match images
				const width = Math.max( modalRefImg.naturalWidth, modalNewImg.naturalWidth );
				const height = Math.max( modalRefImg.naturalHeight, modalNewImg.naturalHeight );
				modalCanvas.width = width;
				modalCanvas.height = height;
				
				const ctx = modalCanvas.getContext( "2d" );
				
				// Draw reference image
				ctx.drawImage( modalRefImg, 0, 0 );
				const refData = ctx.getImageData( 0, 0, width, height );
				
				// Draw new image
				ctx.clearRect( 0, 0, width, height );
				ctx.drawImage( modalNewImg, 0, 0 );
				const newData = ctx.getImageData( 0, 0, width, height );
				
				// Create diff image
				const diffData = ctx.createImageData( width, height );
				
				for( let i = 0; i < refData.data.length; i += 4 ) {
					const rDiff = Math.abs( refData.data[ i ] - newData.data[ i ] );
					const gDiff = Math.abs( refData.data[ i + 1 ] - newData.data[ i + 1 ] );
					const bDiff = Math.abs( refData.data[ i + 2 ] - newData.data[ i + 2 ] );
					const aDiff = Math.abs( refData.data[ i + 3 ] - newData.data[ i + 3 ] );
					
					// Calculate total difference
					const totalDiff = rDiff + gDiff + bDiff + aDiff;
					
					if( totalDiff > 10 ) {
						// Show difference in bright red
						diffData.data[ i ] = 255;
						diffData.data[ i + 1 ] = 0;
						diffData.data[ i + 2 ] = 0;
						diffData.data[ i + 3 ] = 255;
					} else {
						// Show matching pixels dimmed
						diffData.data[ i ] = newData.data[ i ] * 0.3;
						diffData.data[ i + 1 ] = newData.data[ i + 1 ] * 0.3;
						diffData.data[ i + 2 ] = newData.data[ i + 2 ] * 0.3;
						diffData.data[ i + 3 ] = newData.data[ i + 3 ];
					}
				}
				
				// Draw diff and show canvas
				ctx.putImageData( diffData, 0, 0 );
				modalCanvas.classList.add( "visible" );
			} );
		}
		
		function resetBaseImage() {
			if( !currentBaseName ) {
				alert( "No test selected" );
				return;
			}
			
			// Confirm with user
			const confirmed = confirm( 
				`Are you sure you want to reset the base image for "${currentBaseName}"?\n\n` +
				`This will replace the reference screenshot with the current test output.\n` +
				`The test will pass on the next run.`
			);
			
			if( !confirmed ) {
				return;
			}
			
			// Disable button during request
			const resetBtn = document.getElementById( "resetBaseBtn" );
			resetBtn.disabled = true;
			resetBtn.textContent = "Resetting...";
			
			// Send POST request to server
			fetch( "/api/reset-base-image", {
				"method": "POST",
				"headers": {
					"Content-Type": "application/json"
				},
				"body": JSON.stringify( { "baseName": currentBaseName } )
			} )
			.then( response => response.json() )
			.then( data => {
				if( data.success ) {
										
					// Reload the page - the test will be auto-marked as skipped
					location.reload();
				} else {
					alert( `Error: ${data.error}` );
				}
			} )
			.catch( err => {
				alert( `Error resetting base image: ${err.message}` );
			} )
			.finally( () => {
				// Re-enable button
				resetBtn.disabled = false;
				resetBtn.textContent = "Reset Base Image";
			} );
		}
		
		function closeModal() {
			const modal = document.getElementById( "diffModal" );
			modal.classList.remove( "visible" );
			currentBaseName = null;
		}
		
		function showNewTestModal( testName, baseName, newPath ) {

			// Store baseName for approve operation
			currentNewTestBaseName = baseName;
			const modal = document.getElementById( "newTestModal" );
			const modalTitle = document.getElementById( "newTestModalTitle" );
			const modalImg = document.getElementById( "newTestImg" );
			
			// Set title
			modalTitle.textContent = `New Test Screenshot: ${testName}`;
			
			// Set image source
			modalImg.src = newPath;
			
			// Show modal
			modal.classList.add( "visible" );
		}
		
		function closeNewTestModal() {
			const modal = document.getElementById( "newTestModal" );
			modal.classList.remove( "visible" );
			currentNewTestBaseName = null;
		}
		
		function approveNewTest() {
			if( !currentNewTestBaseName ) {
				alert( "No test selected" );
				return;
			}
			
			// Confirm with user
			const confirmed = confirm( 
				`Are you sure you want to approve "${currentNewTestBaseName}" as a new test?\n\n` +
				`This will set the current screenshot as the reference image.\n` +
				`The test will pass on the next run.`
			);
			
			if( !confirmed ) {
				return;
			}
			
			// Disable button during request
			const approveBtn = document.getElementById( "approveTestBtn" );
			approveBtn.disabled = true;
			approveBtn.textContent = "Approving...";
			
			// Send POST request to server
			fetch( "/api/approve-new-test", {
				"method": "POST",
				"headers": {
					"Content-Type": "application/json"
				},
				"body": JSON.stringify( { "baseName": currentNewTestBaseName } )
			} )
			.then( response => response.json() )
			.then( data => {
				if( data.success ) {
					// Reload the page - the test will be auto-marked as skipped
					location.reload();
				} else {
					alert( `Error: ${data.error}` );
				}
			} )
			.catch( err => {
				alert( `Error approving new test: ${err.message}` );
			} )
			.finally( () => {
				// Re-enable button
				approveBtn.disabled = false;
				approveBtn.textContent = "Approve & Set as Reference";
			} );
		}
		
		// Close modal on ESC key
		document.addEventListener( "keydown", function( e ) {
			if( e.key === "Escape" ) {
				closeModal();
				closeNewTestModal();
			}
		} );
		
		// Close modal on background click
		document.getElementById( "diffModal" ).addEventListener( "click", function( e ) {
			if( e.target === this ) {
				closeModal();
			}
		} );
		
		document.getElementById( "newTestModal" ).addEventListener( "click", function( e ) {
			if( e.target === this ) {
				closeNewTestModal();
			}
		} );
	</script>
</body>
</html>

