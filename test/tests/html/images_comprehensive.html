<!DOCTYPE html>
<html>
	<head>
		<title>Images Comprehensive Test</title>
		<script type="text/toml">
			[[TOML_START]]
			file = "images_comprehensive"
			name = "Images Comprehensive Test"
			width = 800
			height = 600
			delay = 0
			[[TOML_END]]
		</script>
		<!-- [Pi.js Script]-->
		<script src="../../../build/pi.js"></script>
		<!-- [/Pi.js Script]-->
		<style>
			html, body {
				background-color: grey;
			}
		</style>
	</head>
<body>

<!-- Test images -->
<img id="spaceship" src="../../media/spaceship_0.png" style="display:none"/>
<img id="thief" src="../../media/thief.png" style="display:none"/>
<img id="squares" src="../../media/squares.png" style="display:none"/>
<img id="fruits" src="../../media/Fruits.png" style="display:none"/>

<script>
	// Test variables
	var testResults = [];
	var currentSection = 0;
	var sectionNames = [
		"loadImage Tests",
		"loadSpritesheet Tests", 
		"removeImage Tests",
		"getImage Tests",
		"getSpritesheetData Tests",
		"drawImage Tests",
		"drawSprite Tests"
	];

	function logTest( testName, result ) {
		testResults.push( testName + ": " + ( result ? "PASS" : "FAIL" ) );
	}

	function drawTestResults() {
		$.setColor( 10 );
		$.setPos( 1, 1 );
		$.print( "=== Test Results ===" );
		
		var passCount = 0;
		var failCount = 0;
		
		for( var i = 0; i < testResults.length; i++ ) {
			var result = testResults[ i ];
			if( result.indexOf( "PASS" ) !== -1 ) {
				passCount++;
				$.setColor( 2 );
			} else {
				failCount++;
				$.setColor( 9 );
			}
			$.print( " " + result );
		}
		
		$.setColor( 15 );
		$.print();
		$.print( "Total: " + ( passCount + failCount ) + " tests" );
		$.print( "Passed: " + passCount + ", Failed: " + failCount );
	}

	// Test loadImage with various input types
	function testLoadImage() {
		
		// Test 1: Load image from URL string
		try {
			$.loadImage( "../../media/spaceship_0.png", "ship_url" );
			logTest( "loadImage URL string", true );
		} catch( e ) {
			logTest( "loadImage URL string", false );
		}
		
		// Test 2: Load image from Image element
		try {
			var imgElement = document.getElementById( "spaceship" );
			$.loadImage( imgElement, "ship_element" );
			logTest( "loadImage Image element", true );
		} catch( e ) {
			logTest( "loadImage Image element", false );
		}
		
		// Test 3: Load image with auto-generated name
		try {
			var autoName = $.loadImage( "../../media/spaceship_0.png" );
			logTest( "loadImage auto name", autoName && autoName !== "" );
		} catch( e ) {
			logTest( "loadImage auto name", false );
		}
		
		// Test 4: Load image with callbacks
		var loadCallbackCalled = false;
		var errorCallbackCalled = false;
		
		try {
			$.loadImage( {
				"src": "../../media/spaceship_0.png",
				"name": "ship_callbacks",
				"onLoad": function( img ) {
					loadCallbackCalled = true;
				},
				"onError": function( err ) {
					errorCallbackCalled = true;
				}
			} );
			logTest( "loadImage with callbacks", true );
		} catch( e ) {
			logTest( "loadImage with callbacks", false );
		}
		
		// Test 5: Error handling - invalid src
		try {
			$.loadImage( "", "invalid_src" );
			logTest( "loadImage invalid src error", false );
		} catch( e ) {
			logTest( "loadImage invalid src error", e.code === "INVALID_SRC" );
		}
		
		// Test 6: Error handling - duplicate name
		try {
			$.loadImage( "../../media/spaceship_0.png", "ship_url" );
			logTest( "loadImage duplicate name error", false );
		} catch( e ) {
			logTest( "loadImage duplicate name error", e.code === "INVALID_NAME" );
		}
	}

	// Test loadSpritesheet with fixed and auto modes
	function testLoadSpritesheet() {
		
		// Test 1: Load spritesheet with fixed dimensions
		try {
			$.loadSpritesheet( "../../media/squares.png", "squares_fixed", 32, 32, 0 );
			logTest( "loadSpritesheet fixed dimensions", true );
		} catch( e ) {
			logTest( "loadSpritesheet fixed dimensions", false );
		}
		
		// Test 2: Load spritesheet with margin
		try {
			$.loadSpritesheet( "../../media/thief.png", "thief_margin", 32, 32, 1 );
			logTest( "loadSpritesheet with margin", true );
		} catch( e ) {
			logTest( "loadSpritesheet with margin", false );
		}
		
		// Test 3: Load spritesheet with auto-detection
		try {
			$.loadSpritesheet( "../../media/Fruits.png", "fruits_auto" );
			logTest( "loadSpritesheet auto detection", true );
		} catch( e ) {
			logTest( "loadSpritesheet auto detection", false );
		}
		
		// Test 4: Load spritesheet from Image element
		try {
			var imgElement = document.getElementById( "thief" );
			$.loadSpritesheet( imgElement, "thief_element", 32, 32, 1 );
			logTest( "loadSpritesheet Image element", true );
		} catch( e ) {
			logTest( "loadSpritesheet Image element", false );
		}
		
		// Test 5: Error handling - invalid dimensions
		try {
			$.loadSpritesheet( "../../media/squares.png", "invalid_dims", 0, 32 );
			logTest( "loadSpritesheet invalid dimensions error", false );
		} catch( e ) {
			logTest( "loadSpritesheet invalid dimensions error", e.code === "INVALID_DIMENSIONS" );
		}
		
		// Test 6: Error handling - invalid margin
		try {
			$.loadSpritesheet( "../../media/squares.png", "invalid_margin", 32, 32, "invalid" );
			logTest( "loadSpritesheet invalid margin error", false );
		} catch( e ) {
			logTest( "loadSpritesheet invalid margin error", e.code === "INVALID_MARGIN" );
		}
	}

	// Test removeImage functionality
	function testRemoveImage() {
		
		// Test 1: Remove existing image
		try {
			$.removeImage( "ship_url" );
			logTest( "removeImage existing image", true );
		} catch( e ) {
			logTest( "removeImage existing image", false );
		}
		
		// Test 2: Remove non-existent image (should not throw)
		try {
			$.removeImage( "non_existent" );
			logTest( "removeImage non-existent image", true );
		} catch( e ) {
			logTest( "removeImage non-existent image", false );
		}
		
		// Test 3: Error handling - invalid name type
		try {
			$.removeImage( 123 );
			logTest( "removeImage invalid name type error", false );
		} catch( e ) {
			logTest( "removeImage invalid name type error", e.code === "INVALID_NAME" );
		}
		
		// Test 4: Verify image is actually removed
		try {
			$.drawImage( "ship_url", 100, 100 );
			logTest( "removeImage verification", false );
		} catch( e ) {
			logTest( "removeImage verification", e.code === "IMAGE_NOT_FOUND" );
		}
	}

	// Test getImage (screen capture) functionality
	function testGetImage() {
		
		// Draw some content to capture in quadrant 1 (top-right)
		$.setColor( 4 );
		$.rect( 300, 25, 100, 100 );
		$.setColor( 6 );
		$.circle( 350, 75, 30, "purple" );

		$.setColor( 5 );
		$.rect( 450, 25, 100, 100 );
		$.setColor( 9 );
		$.bezier( 475, 35, 575, 55, 525, 75, 465, 120 );
		$.line( 475, 35, 465, 120 );
		$.paint( 500, 50, 11 );
		
		// Test 1: Capture screen region
		try {
			var captureName = $.getImage( "screen_capture", 300, 25, 400, 125 );
			logTest( "getImage screen capture", captureName === "screen_capture" );
		} catch( e ) {
			logTest( "getImage screen capture", false );
		}
		
		// Test 2: Capture with auto-generated name
		try {
			var autoName = $.getImage( null, 450, 25, 600, 125 );
			logTest( "getImage auto name", autoName && autoName !== "" );
		} catch( e ) {
			logTest( "getImage auto name", false );
		}
		
		// Test 3: Error handling - invalid coordinates
		try {
			$.getImage( "invalid_coords", "invalid", 50, 150, 100 );
			logTest( "getImage invalid coordinates error", false );
		} catch( e ) {
			logTest( "getImage invalid coordinates error", e.code === "INVALID_COORDINATES" );
		}
		
		// Test 4: Error handling - duplicate name
		try {
			$.getImage( "screen_capture", 300, 300, 350, 350 );
			logTest( "getImage duplicate name error", false );
		} catch( e ) {
			logTest( "getImage duplicate name error", e.code === "DUPLICATE_NAME" );
		}
		
		for( let i = 0; i < 2; i += 1 ) {

			// Test 5i: Draw captured image in quadrant 2 (top-right)
			try {
				$.drawImage( "screen_capture", 300 + i * 300, 175 );
				logTest( `getImage draw captured (${i})`, true );
			} catch( e ) {
				logTest( `getImage draw captured (${i})`, false );
			}

			// Test 6i: Draw captured image in quadrant 2 (top-right)
			try {
				$.drawImage( autoName, 450 + i * 300, 175 );
				logTest( `getImage draw captured auto name (${i})`, true );
			} catch( e ) {
				logTest( `getImage draw captured auto name (${i})`, false );
			}
		}
		
	}

	// Test getSpritesheetData functionality
	function testGetSpritesheetData() {
		
		// Test 1: Get data from fixed spritesheet
		try {
			var spriteData = $.getSpritesheetData( "squares_fixed" );
			var hasFrameCount = spriteData && typeof spriteData.frameCount === "number";
			var hasFrames = spriteData && Array.isArray( spriteData.frames );
			logTest( "getSpritesheetData fixed spritesheet", hasFrameCount && hasFrames );
		} catch( e ) {
			logTest( "getSpritesheetData fixed spritesheet", false );
		}
		
		// Test 2: Get data from auto-detected spritesheet
		try {
			var spriteData = $.getSpritesheetData( "fruits_auto" );
			var hasFrameCount = spriteData && typeof spriteData.frameCount === "number";
			var hasFrames = spriteData && Array.isArray( spriteData.frames );
			logTest( "getSpritesheetData auto spritesheet", hasFrameCount && hasFrames );
		} catch( e ) {
			logTest( "getSpritesheetData auto spritesheet", false );
		}
		
		// Test 3: Error handling - invalid name
		try {
			$.getSpritesheetData( "non_existent" );
			logTest( "getSpritesheetData invalid name error", false );
		} catch( e ) {
			logTest( "getSpritesheetData invalid name error", e.code === "INVALID_NAME" );
		}
		
		// Test 4: Error handling - not a spritesheet
		try {
			$.getSpritesheetData( "ship_element" );
			logTest( "getSpritesheetData not spritesheet error", false );
		} catch( e ) {
			logTest( "getSpritesheetData not spritesheet error", e.code === "NOT_A_SPRITESHEET" );
		}
		
		// Test 5: Verify frame data structure
		try {
			var spriteData = $.getSpritesheetData( "squares_fixed" );
			var frame = spriteData.frames[ 0 ];
			var hasRequiredProps = frame && 
				typeof frame.index === "number" &&
				typeof frame.x === "number" &&
				typeof frame.y === "number" &&
				typeof frame.width === "number" &&
				typeof frame.height === "number";
			logTest( "getSpritesheetData frame structure", hasRequiredProps );
		} catch( e ) {
			logTest( "getSpritesheetData frame structure", false );
		}
	}

	// Test drawImage functionality
	function testDrawImage() {
		
		// Test 1: Draw loaded image in quadrant 3 (bottom-left)
		try {
			$.drawImage( "ship_element", 300, 350 );
			logTest( "drawImage loaded image", true );
		} catch( e ) {
			logTest( "drawImage loaded image", false );
		}
		
		// Test 2: Draw image with transformations
		try {
			$.drawImage( "ship_element", 400, 350, 45, 0.5, 0.5, 128, 2, 2 );
			logTest( "drawImage with transformations", true );
		} catch( e ) {
			logTest( "drawImage with transformations", false );
		}
		
		// Test 3: Draw captured image
		try {
			$.drawImage( "screen_capture", 450, 315 );
			logTest( "drawImage captured image", true );
		} catch( e ) {
			logTest( "drawImage captured image", false );
		}
		
		// Test 4: Draw from Image element directly
		try {
			var imgElement = document.getElementById( "spaceship" );
			$.drawImage( imgElement, 580, 350 );
			logTest( "drawImage Image element", true );
		} catch( e ) {
			logTest( "drawImage Image element", false );
		}
		
		// Test 5: Draw from Screen element (screen)
		try {

			const tempScreen = $.screen( "35x35", null, true );
			$.print( "ABCDEFGHIJ" );
			tempScreen.render();
			$.setScreen( 0 );
			$.drawImage( tempScreen, 650, 350 );
			logTest( "drawImage Canvas element", true );
		} catch( e ) {
			logTest( "drawImage Canvas element", false );
		}
		
		// Test 6: Error handling - image not found
		try {
			$.drawImage( "non_existent", 100, 100 );
			logTest( "drawImage not found error", false );
		} catch( e ) {
			logTest( "drawImage not found error", e.code === "IMAGE_NOT_FOUND" );
		}
		
		// Test 7: Error handling - image still loading
		try {
			$.loadImage( "../../media/spaceship_0.png", "loading_image" );
			$.drawImage( "loading_image", 100, 100 );
			logTest( "drawImage loading error", false );
		} catch( e ) {
			logTest( "drawImage loading error", e.code === "IMAGE_NOT_READY" );
		}
		
		// Test 8: Error handling - invalid coordinates
		try {
			$.drawImage( "ship_element", "invalid", 100 );
			logTest( "drawImage invalid coordinates error", false );
		} catch( e ) {
			logTest( "drawImage invalid coordinates error", e.code === "INVALID_COORDINATES" );
		}
	}

	// Test drawSprite functionality
	function testDrawSprite() {
		
		// Test 1: Draw sprite from fixed spritesheet in quadrant 4 (bottom-right)
		try {
			$.drawSprite( "squares_fixed", 0, 300, 500 );
			logTest( "drawSprite fixed spritesheet", true );
		} catch( e ) {
			logTest( "drawSprite fixed spritesheet", false );
		}
		
		// Test 2: Draw sprite with transformations
		try {
			$.drawSprite( "squares_fixed", 1, 400, 515, 45, 0.5, 0.5, 128, 2, 2 );
			logTest( "drawSprite with transformations", true );
		} catch( e ) {
			logTest( "drawSprite with transformations", false );
		}
		
		// Test 3: Draw sprite from auto-detected spritesheet
		try {
			$.drawSprite( "fruits_auto", 0, 475, 500 );
			logTest( "drawSprite auto spritesheet", true );
		} catch( e ) {
			logTest( "drawSprite auto spritesheet", false );
		}
		
		// Test 4: Draw multiple frames
		try {
			$.drawSprite( "fruits_auto", 1, 525, 500 );
			$.drawSprite( "fruits_auto", 2, 575, 505 );
			logTest( "drawSprite multiple frames", true );
		} catch( e ) {
			logTest( "drawSprite multiple frames", false );
		}
		
		// Test 5: Error handling - invalid name
		try {
			$.drawSprite( "non_existent", 0, 100, 100 );
			logTest( "drawSprite invalid name error", false );
		} catch( e ) {
			logTest( "drawSprite invalid name error", e.code === "INVALID_NAME" );
		}
		
		// Test 6: Error handling - not a spritesheet
		try {
			$.drawSprite( "ship_element", 0, 100, 100 );
			logTest( "drawSprite not spritesheet error", false );
		} catch( e ) {
			logTest( "drawSprite not spritesheet error", e.code === "NOT_A_SPRITESHEET" );
		}
		
		// Test 7: Error handling - invalid frame
		try {
			$.drawSprite( "squares_fixed", 999, 100, 100 );
			logTest( "drawSprite invalid frame error", false );
		} catch( e ) {
			logTest( "drawSprite invalid frame error", e.code === "INVALID_FRAME" );
		}
		
		// Test 8: Error handling - invalid coordinates
		try {
			$.drawSprite( "squares_fixed", 0, "invalid", 100 );
			logTest( "drawSprite invalid coordinates error", false );
		} catch( e ) {
			logTest( "drawSprite invalid coordinates error", e.code === "INVALID_COORDINATES" );
		}
	}

	// Draw quadrant separators and labels
	function drawQuadrantLabels() {

		// Draw vertical separator line
		$.setColor( 7 );
		$.line( 290, 0, 290, 600 );
		
		// Draw horizontal separator lines
		$.line( 290, 145, 800, 145 );
		$.line( 290, 290, 800, 290 );
		$.line( 290, 435, 800, 435 );
		
		// Quadrant labels
		$.setColor( 14 );
		$.setPos( 49, 1 );
		$.print( "Quadrant 1: getImage Tests" );
		$.setPos( 49, 19 );
		$.print( "Quadrant 2: getImage Results" );
		$.setPos( 49, 37 );
		$.print( "Quadrant 3: drawImage Tests" );
		$.setPos( 49, 55 );
		$.print( "Quadrant 4: drawSprite Tests" );
	}

	$.screen( "800x600" );
	$.setColor( 1 );
	testLoadImage();
	testLoadSpritesheet();

	// Main test execution
	$.ready( function() {
		
		// Draw quadrant separators and labels
		drawQuadrantLabels();
		
		// Run all tests
		testRemoveImage();
		testGetImage();
		testGetSpritesheetData();
		testDrawImage();
		testDrawSprite();
		
		// Draw test results
		drawTestResults();

	} );
</script>
</body>
</html>
