<!DOCTYPE html>
<html>
	<head>
		<title>Screen Comprehensive Test</title>
		<script type="text/toml">
			[[TOML_START]]
			file = "screen_comprehensive_01"
			name = "Screen Comprehensive Test"
			width = 820
			height = 620
			delay = 100
			[[TOML_END]]
		</script>
		<script src="../../../build/pi.js"></script>
		<style>
			html, body {
				background-color: #333;
				margin: 0;
				padding: 10px;
				width: 800px;
				height: 600px;
			}
			.container {
				display: inline-block;
				vertical-align: top;
				margin: 5px;
				background-color: #555;
				width: 160px;
				height: 120px;
				padding: 0;
			}
			.container.wide {
				width: 320px;
			}
			#removed-indicator {
				font-weight: bold;
				color: #0f0;
				font-family: monospace;
				font-size: 12px;
			}
		</style>
	</head>
<body>
	<div class="container" id="c1"></div>
	<div class="container" id="c2"></div>
	<div class="container" id="c3"></div>
	<div class="container" id="c4"></div>
	<div class="container" id="c5"></div>
	<div class="container" id="c6"></div>
	<div class="container" id="c7"></div>
	<div  class="container" id="removed-indicator"></div>
	<div class="container" id="c8"></div>
	<div class="container" id="c9"></div>
	<div class="container" id="c10"></div>
	<div class="container" id="c11"></div>
	<div class="container" id="c12"></div>
	<div class="container" id="c13"></div>
<script>
	$.ready( function () {

		// Test 1: 120x120 exact pixels (x format)
		const s1 = $.screen( {
			"aspect": "120x120",
			"container": document.getElementById( "c1" )
		} );
		$.setColor( 8 );
		$.setFont( 1 );
		$.print( "120x120 exact" );
		$.print( "w=" + $.width() + " h=" + $.height() );
		$.rect( 5, 5, $.width() - 10, $.height() - 10 );
		if( $.width() === 120 && $.width() === 120 ) {
			$.setColor( 2 );
			$.print( "Success!" );
		} else {
			$.setColor( 4 );
			$.print( "Failed" );
		}

		// Test 2: 4:3 aspect ratio (: format)
		const s2 = $.screen( {
			"aspect": "4:3",
			"container": document.getElementById( "c2" )
		} );
		$.setColor( 7 );
		$.setFont( 1 );
		$.print( "4:3 ratio" );
		$.print( "w=" + $.width() + " h=" + $.height() );
		$.circle( $.width() / 2, $.height() / 2, 20 );
		const ratio = ( $.width() / $.height() ).toFixed( 2 );
		if( ratio === ( 4 / 3 ).toFixed( 2 ) ) {
			$.setColor( 2 );
			$.print( "4:3 ratio success!" );
		} else {
			$.setColor( 4 );
			$.print( "4:3 ratio failed" );
		}

		// Test 3: 70m60 exact multiples (m format)
		const s3 = $.screen( {
			"aspect": "70m60",
			"container": document.getElementById( "c3" )
		} );
		$.setColor( 11 );
		$.setFont( 1 );
		$.print( "70m60 mult" );
		$.print( "w=" + $.width() + " h=" + $.height() );
		$.line( 0, 0, $.width() - 1, $.height() - 1 );
		$.line( $.width() - 1, 0, 0, $.height() - 1 );
		if( $.width() === 70 && $.height() == 60 ) {
			$.setColor( 2 );
			$.print( "Success!" );
		} else {
			$.setColor( 4 );
			$.print( "Failed" );
		}

		// Test 4: 50e50 extend (e format)
		const c4 = document.getElementById( "c4" );
		const s4 = $.screen( {
			"aspect": "50e50",
			"container": c4
		} );
		$.setColor( 14 );
		$.setFont( 1 );
		$.print( "50e50 extend" );
		$.print( "w=" + $.width() + " h=" + $.height() );
		$.rect( 0, 0, $.width() - 1, $.height() - 1 );
		const pw = c4.offsetWidth / $.width();
		const ph = c4.offsetHeight / $.height();
		$.print( `PW: ${pw} PH: ${ph}` );

		// Check if pixels are integers
		if( pw === Math.round( pw ) && ph === Math.round( ph ) ) {
			$.setColor( 2 );
			$.print( "Success!" );
		} else {
			$.setColor( 4 );
			$.print( "Failed" );
		}

		// Test 5: noStyles option
		const c5 = document.getElementById( "c5" );
		const s5 = $.screen( {
			"aspect": "160x120",
			"container": c5,
			"noStyles": true
		} );
		$.setColor( 10 );
		$.setFont( 1 );
		$.print( "noStyles" );
		$.print( "w=" + $.width() + " h=" + $.height() );
		$.pset( 80, 60 );
		if( c5.offsetWidth === $.width() && c5.offsetHeight === $.height() ) {
			$.setColor( 2 );
			$.print( "Success!" );
		} else {
			$.setColor( 4 );
			$.print( "Failed" );
		}

		// Test 6: Offscreen canvas - draw to it then display
		const offscreen = $.screen( {
			"aspect": "80x60",
			"isOffscreen": true
		} );
		$.setColor( 13 );
		$.setFont( 1 );
		$.print( "Offscreen" );
		$.circle( 40, 30, 25 );

		// Test 7: Display offscreen canvas
		const s6 = $.screen( {
			"aspect": "160x120",
			"container": document.getElementById( "c6" )
		} );
		$.setColor( 15 );
		$.setFont( 1 );
		$.print( "From offscreen:" );
		$.drawImage( offscreen, 0, 20 );
		offscreen.print( "Updated!" );
		$.drawImage( offscreen, 80, 20 );

		// Test 8: Create screen to be removed
		const toRemove = $.screen( {
			"aspect": "160x120",
			"container": document.getElementById( "c7" )
		} );
		$.setColor( 8 );
		$.setFont( 1 );
		$.print( "Will be removed" );
		$.rect( 10, 10, 140, 100 );
		

		// Test removeScreen() and verify it throws errors after removal
		const divRemoved = document.getElementById( "removed-indicator" );
		$.removeScreen( toRemove );
		//toRemove.removeScreen();
		try {
			toRemove.print( "Should fail" );
			divRemoved.style.color = "red";
			divRemoved.innerHTML = "Removed - Failed";
		} catch( e ) {
			errorCaught = true;
			divRemoved.innerHTML = "Removed - Success!";
		}

		// Test setScreen() and getScreen()
		const s7 = $.screen( {
			"aspect": "160x120",
			"container": document.getElementById( "c8" )
		} );
		$.setColor( 2 );
		$.setFont( 1 );
		$.print( "setScreen test" );
		const s7id = s7.id;
		

		// Switch to s1 and back using setScreen
		$.setScreen( s1 );
		$.print( "Switched To Screen Success" );
		$.setScreen( s7 );
		$.print( "Switched back success" );
		

		// Test 10: Test getScreen()
		const s8 = $.screen( {
			"aspect": "160x120",
			"container": document.getElementById( "c9" )
		} );

		$.setScreen( 0 );
		const retrievedScreen = $.getScreen( s8.id );
		retrievedScreen.setColor( 6 );
		retrievedScreen.setFont( 1 );
		retrievedScreen.print( "getScreen test" );
		retrievedScreen.print( "id=" + s8.id );
		
		// Test 14: create 2 screens in a container and resize them
		const resizeFn = ( screen, fromSize, toSize ) => {
			const fromDim = `${fromSize.width}x${fromSize.height}`;
			const toDim = `${toSize.width}x${toSize.height}`;
			let screenNum;
			if( screen === s12 ) {
				screen.setPos( 0, 1 );
				screenNum = 1;
			} else if ( screen === s13 ) {
				screen.setPos( 0, 5 );
				screenNum = 2;
			}
			screen.setColor( 2 );
			screen.print( `Screen ${screenNum} resized from ${fromDim} to ${toDim}` );
		};
		const s12 = $.screen( {
			"aspect": "320x120",
			"container": document.getElementById( "c13" ),
			"resizeCallback": resizeFn
		} );
		s12.print( "Test 13: Screen 1" );
		const s13 = $.screen( {
			"aspect": "320x120",
			"container": document.getElementById( "c13" ),
			"resizeCallback": resizeFn
		} );
		s13.setBgColor( "#00000000" );
		s13.print( "\n\n\n" );
		s13.print( "Test 13: Screen 2" );
		s13.canvas().parentElement.classList.add( "wide" );

	} );
</script>
</body>
</html>

