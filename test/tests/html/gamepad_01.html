<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Gamepad Test 01 - Basic Gamepad Support</title>
	<script src="../../../build/pi.js"></script>
	<style>body { background-color: gray; };</style>
</head>
<body>
<script>

/*+++
title = "Gamepad Test 01 - Basic Gamepad Support"
description = "Tests gamepad connection, button events, and axis events"
+++*/

$.screen( "320x200" );

let gamepadConnected = false;
let gamepadIndex = null;
let buttonPressed = "";
let sensitivity = 0.2;
let axis0Value = 0;
let axis1Value = 0;
let axis2Value = 0;
let axis3Value = 0;

// Button states for visual display
const buttonStates = {
	0: false, // A button
	1: false, // B button
	2: false, // X button
	3: false, // Y button
	4: false, // D-pad Up
	5: false, // D-pad Down
	6: false, // D-pad Left
	7: false, // D-pad Right
	8: false, // Left Shoulder
	9: false, // Right Shoulder
	10: false, // Left Trigger
	11: false, // Right Trigger
	12: false, // Back/Select
	13: false, // Start
	14: false, // Left Stick Click
	15: false  // Right Stick Click
};

// Connection events
$.onGamepadConnected( ( data ) => {
	gamepadConnected = true;
	gamepadIndex = data.index;
} );

$.onGamepadDisconnected( ( data ) => {
	gamepadConnected = false;
	gamepadIndex = null;
} );

// Sensitivity controls
$.onkey( "ArrowUp", "down", () => {
	sensitivity = Math.min( 1, sensitivity + 0.05 );
	$.setGamepadSensitivity( sensitivity );
} );

$.onkey( "ArrowDown", "down", () => {
	sensitivity = Math.max( 0, sensitivity - 0.05 );
	$.setGamepadSensitivity( sensitivity );
} );


// Draw loop
function draw() {
	$.cls( 0 );
	$.setColor( 15 );
	
	// Title
	$.setPos( 0, 0 );
	$.print( "GAMEPAD TEST - Basic Support" );
	
	// Connection status
	$.setPos( 0, 2 );
	if( gamepadConnected ) {
		$.setColor( 10 );
		$.print( `Gamepad ${gamepadIndex} connected!` );
	} else {
		$.setColor( 8 );
		$.print( "No gamepad connected. Press a button to connect." );
	}
	
	// Instructions
	$.setColor( 15 );
	$.setPos( 0, 4 );
	$.print( "Instructions:" );
	$.print( "- Move analog sticks" );
	$.print( "- Press any button" );
	$.print( "- UP/DOWN: adjust sensitivity" );
	
	// Sensitivity display
	$.setPosPx( 6, 67 );
	$.setColor( 14 );
	$.print( `Sensitivity: ${sensitivity.toFixed( 2 )}` );
	
	// Poll gamepad state
	if( gamepadConnected && gamepadIndex !== null ) {
		const gamepad = $.ingamepad( gamepadIndex );
		if( gamepad ) {

			// Update button states
			for( let i = 0; i < 16; i++ ) {
				if( gamepad.getButtonJustPressed( i ) ) {
					buttonStates[ i ] = true;
					buttonPressed = `Button ${i} pressed!`;
				} else if( gamepad.getButtonJustReleased( i ) ) {
					buttonStates[ i ] = false;
					buttonPressed = "";
				}
			}
			
			// Update axis values
			axis0Value = gamepad.getAxis( 0 );
			axis1Value = gamepad.getAxis( 1 );
			axis2Value = gamepad.getAxis( 2 );
			axis3Value = gamepad.getAxis( 3 );
		}
	}
	
	// Button press message
	if( buttonPressed ) {
		$.setColor( 11 );
		$.setPosPx( 6, 76 );
		$.print( buttonPressed );
	}
	
	let axisRow = 11;

	// Axis bars
	$.setColor( 15 );
	$.setPos( 1, axisRow );
	$.print( "Left Stick X (Axis 0):" );
	drawAxisBar( axisRow + 1, axis0Value );
	axisRow += 2;
	
	$.setPos( 1, axisRow );
	$.print( "Left Stick Y (Axis 1):" );
	drawAxisBar( axisRow + 1, axis1Value );
	axisRow += 2;
	
	$.setPos( 1, axisRow );
	$.print( "Right Stick X (Axis 2):" );
	drawAxisBar( axisRow + 1, axis2Value );
	axisRow += 2;
	
	$.setPos( 1, axisRow );
	$.print( "Right Stick Y (Axis 3):" );
	drawAxisBar( axisRow + 1, axis3Value );
	
	// Draw all gamepad buttons
	drawGamepadButtons();
	
	// Visual representation of sticks
	$.setColor( 8 );
	
	const stickHeight = 170;

	// Left stick
	if( buttonStates[ 10 ] ) {
		$.setColor( 14 );
	} else {
		$.setColor( 8 );
	}
	$.circle( 80, stickHeight, 15 );
	$.setColor( 11 );
	const leftX = 80 + axis0Value * 12;
	const leftY = stickHeight + axis1Value * 12;
	$.circle( leftX, leftY, 4 );
	
	// Right stick
	if( buttonStates[ 11 ] ) {
		$.setColor( 14 );
	} else {
		$.setColor( 8 );
	}
	$.circle( 240, stickHeight, 15 );
	$.setColor( 11 );
	const rightX = 240 + axis2Value * 12;
	const rightY = stickHeight + axis3Value * 12;
	$.circle( rightX, rightY, 4 );
	
	// Better aligned stick labels
	$.setColor( 15 );
	$.setPosPx( 55, 185 );
	$.print( "Left Stick", true );
	$.setPosPx( 209, 185 );
	$.print( "Right Stick", true );
	
	requestAnimationFrame( draw );
}

function drawGamepadButtons() {

	// Draw dpads
	drawRectButton( 209, 94, 12, 12, 12, "^" );
	drawRectButton( 209, 124, 12, 12, 13, "v" );
	drawRectButton( 195, 109, 12, 12, 14, "<" );
	drawRectButton( 222, 109, 12, 12, 15, ">" );
	
	// Draw face buttons (XYAB) with X and B centered vertically
	drawCircleButton( 275, 130, 10, 0, "A" );
	drawCircleButton( 295, 115, 10, 1, "B" );
	drawCircleButton( 255, 115, 10, 2, "X" );
	drawCircleButton( 275, 100, 10, 3, "Y" );

	// Draw back buttons
	drawRectButton( 193, 40, 40, 12, 6, "LB" );
	drawRectButton( 193, 60, 40, 12, 4, "LT" );
	drawRectButton( 253, 40, 40, 12, 7, "RB" );
	drawRectButton( 253, 60, 40, 12, 5, "RT" );

	// Draw Menu Buttons
	drawCircleButton( 229, 85, 6, 8, "-" );
	drawCircleButton( 255, 85, 6, 9, "+" );

}

function drawCircleButton( x, y, size, buttonIndex, label ) {

	// Button circle
	if( buttonStates[ buttonIndex ] ) {
		$.setColor( 14 ); // Bright yellow when pressed
	} else {
		$.setColor( 8 ); // Dark gray when not pressed
	}
	$.circle( x, y, size );
	
	// Button label
	$.setColor( 15 );
	$.setPosPx( x - 3, y - 3 );
	$.print( label );
}

function drawRectButton( x, y, width, height, buttonIndex, label ) {

	// Button rectangle
	if( buttonStates[ buttonIndex ] ) {
		$.setColor( 14 ); // Bright yellow when pressed
	} else {
		$.setColor( 8 ); // Dark gray when not pressed
	}
	$.rect( x, y, width, height );
	
	// Button label (centered)
	$.setColor( 15 );
	$.setPosPx( x + ( width - label.length * 4 ) / 2, y + 2 );
	$.print( label );
}

function drawAxisBar( row, value ) {
	const barWidth = 150;
	const barHeight = 5;
	const centerX = 80;
	const y = row * 8;
	
	// Draw background
	$.setColor( 8 );
	$.rect( centerX - barWidth / 2, y, barWidth, barHeight );
	
	// Draw center line
	$.setColor( 7 );
	$.line( centerX, y, centerX, y + barHeight - 1 );
	
	// Draw value indicator
	const indicatorX = centerX + value * ( barWidth / 2 );
	if( value > 0 ) {
		$.setColor( 10 );
	} else if( value < 0 ) {
		$.setColor( 12 );
	} else {
		$.setColor( 7 );
	}
	$.circle( indicatorX, y + 2, 3 );
	
	// Draw value text
	$.setColor( 15 );
	$.setPosPx( 155, y - 2);
	$.print( value.toFixed( 2 ).padStart( 5, " " ) );
}

draw();

</script>
</body>
</html>

