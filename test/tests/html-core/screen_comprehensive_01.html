<!DOCTYPE html>
<html>
	<head>
		<title>Screen Comprehensive Test</title>
		<script type="text/toml">
			[[TOML_START]]
			file = "screen_comprehensive_01"
			name = "Screen Comprehensive Test"
			lite = true
			width = 820
			height = 620
			delay = 100
			[[TOML_END]]
		</script>
		<script src="../../../build/pi-lite.js"></script>
		<style>
			html, body {
				background-color: #333;
				margin: 0;
				padding: 10px;
				width: 800px;
				height: 800px;
			}
			.container {
				display: inline-block;
				vertical-align: top;
				margin: 5px;
				background-color: #555;
				width: 160px;
				height: 120px;
				padding: 0;
			}
			.container.wide {
				width: 320px;
			}
			.container.big {
				width: 200px;
				height: 160px;
			}
			#removed-indicator {
				font-weight: bold;
				color: #0f0;
				font-family: monospace;
				font-size: 12px;
			}
		</style>
	</head>
<body>
	<div class="container" id="c1"></div>
	<div class="container" id="c2"></div>
	<div class="container" id="c3"></div>
	<div class="container" id="c4"></div>
	<div class="container" id="c5"></div>
	<div  class="container" id="removed-indicator"></div>
	<div class="container" id="c6"></div>
	<div class="container" id="c7"></div>
	<div class="container" id="c8"></div>
	<div class="container" id="c9"></div>
<script>
	$.ready( function () {

		// Test 1: 120x120 exact pixels (x format)
		const s1 = $.screen( {
			"aspect": "120x120",
			"container": document.getElementById( "c1" )
		} );
		$.setColor( 8 );
		$.setFont( 1 );
		$.print( "120x120 exact" );
		$.print( "w=" + $.width() + " h=" + $.height() );
		$.rect( 5, 5, $.width() - 10, $.height() - 10 );
		if( $.width() === 120 && $.width() === 120 ) {
			$.setColor( 2 );
			$.print( "Success!" );
		} else {
			$.setColor( 4 );
			$.print( "Failed" );
		}

		// Test 2: 70m60 exact multiples (m format)
		const s2 = $.screen( {
			"aspect": "70m60",
			"container": document.getElementById( "c2" )
		} );
		$.setColor( 11 );
		$.setFont( 1 );
		$.print( "70m60 mult" );
		$.print( "w=" + $.width() + " h=" + $.height() );
		$.line( 0, 0, $.width() - 1, $.height() - 1 );
		$.line( $.width() - 1, 0, 0, $.height() - 1 );
		if( $.width() === 70 && $.height() == 60 ) {
			$.setColor( 2 );
			$.print( "Success!" );
		} else {
			$.setColor( 4 );
			$.print( "Failed" );
		}

		// Test 3: 50e50 extend (e format)
		const c3 = document.getElementById( "c3" );
		const s3 = $.screen( {
			"aspect": "50e50",
			"container": c3
		} );
		$.setColor( 14 );
		$.setFont( 1 );
		$.print( "50e50 extend" );
		$.print( "w=" + $.width() + " h=" + $.height() );
		$.rect( 0, 0, $.width() - 1, $.height() - 1 );
		const pw = c3.offsetWidth / $.width();
		const ph = c3.offsetHeight / $.height();
		$.print( `PW: ${pw} PH: ${ph}` );

		// Check if pixels are integers
		if( pw === Math.round( pw ) && ph === Math.round( ph ) ) {
			$.setColor( 2 );
			$.print( "Success!" );
		} else {
			$.setColor( 4 );
			$.print( "Failed" );
		}

		// Test 4: Offscreen canvas - draw to it then display
		const offscreen = $.screen( {
			"aspect": "80x60",
			"isOffscreen": true
		} );
		$.setColor( 13 );
		$.setFont( 1 );
		$.print( "Offscreen" );
		$.circle( 40, 30, 25 );

		// Test 4: Display offscreen canvas
		const s4 = $.screen( {
			"aspect": "160x120",
			"container": document.getElementById( "c4" )
		} );
		$.setColor( 15 );
		$.setFont( 1 );
		$.print( "From offscreen:" );
		$.drawImage( offscreen, 0, 20 );
		offscreen.print( "Updated!" );
		$.drawImage( offscreen, 80, 20 );

		// Test 5: Create screen to be removed
		const toRemove = $.screen( {
			"aspect": "160x120",
			"container": document.getElementById( "c5" )
		} );
		$.setColor( 8 );
		$.setFont( 1 );
		$.print( "Will be removed" );
		$.rect( 10, 10, 140, 100 );

		// Test removeScreen() and verify it throws errors after removal
		const divRemoved = document.getElementById( "removed-indicator" );
		$.removeScreen( toRemove );
		//toRemove.removeScreen();
		try {
			toRemove.print( "Should fail" );
			divRemoved.style.color = "red";
			divRemoved.innerHTML = "Removed - Failed";
		} catch( e ) {
			errorCaught = true;
			divRemoved.innerHTML = "Removed - Success!";
		}

		// Test setScreen() and getScreen()
		const s6 = $.screen( {
			"aspect": "160x120",
			"container": document.getElementById( "c6" )
		} );
		$.setColor( 2 );
		$.setFont( 1 );
		$.print( "setScreen test" );
		const s6id = s6.id;

		// Switch to s1 and back using setScreen
		$.setScreen( s1 );
		$.print( "Switched To Screen Success" );
		$.setScreen( s6id );
		$.print( "Switched back success" );
		

		// Test 7: Test getScreen()
		const s7 = $.screen( {
			"aspect": "160x120",
			"container": document.getElementById( "c7" )
		} );

		$.setScreen( 0 );
		const retrievedScreen = $.getScreen( s7.id );
		retrievedScreen.setColor( 6 );
		retrievedScreen.setFont( 1 );
		retrievedScreen.print( "getScreen test" );
		retrievedScreen.print( "id=" + s7.id );
		
		// Test 8: create 2 screens in a container and resize them
		const resizeFn = ( screen, fromSize, toSize ) => {
			const fromDim = `${fromSize.width}x${fromSize.height}`;
			const toDim = `${toSize.width}x${toSize.height}`;
			let screenNum;
			if( screen === s8 ) {
				screen.setPos( 0, 1 );
				screenNum = 1;
			} else if ( screen === s9 ) {
				screen.setPos( 0, 5 );
				screenNum = 2;
			}
			screen.setColor( 2 );
			screen.print( `Screen ${screenNum} resized from ${fromDim} to ${toDim}` );
		};
		const s8 = $.screen( {
			"aspect": "160x60",
			"container": document.getElementById( "c8" ),
			"resizeCallback": resizeFn
		} );
		s8.print( "Test 8: Screen 8" );
		const s9 = $.screen( {
			"aspect": "160x60",
			"container": document.getElementById( "c8" ),
			"resizeCallback": resizeFn
		} );
		s9.setBgColor( "#00000000" );
		s9.print( "\n\n\n" );
		s9.print( "Test 8: Screen 9" );
		s9.canvas().parentElement.classList.add( "wide" );


		// Test 10: Resize a non-fixed aspect like "80e80"
		const c9Resized = ( screen ) => {
			screen.setColor( 2 );
			screen.print( "Screen Resized" );
		};
		const c9 = document.getElementById( "c9" );
		const s10 = $.screen( { "aspect": "80e80", "container": c9, "resizeCallback": c9Resized } );
		
		s10.setColor( 5 );
		s10.line( 0, 0, s10.width() - 1, s10.height() - 1 );
		s10.line( 0, s10.height() - 1, s10.width() - 1, 0 );
		s10.rect( 0, 0, s10.width(), s10.height() );
		s10.setColor( 7 );
		s10.print( "Test 10: Resize 80e80" );
		c9.classList.add( "big" );
	} );
</script>
</body>
</html>

