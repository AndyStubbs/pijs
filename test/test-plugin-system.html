<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Pi.js Plugin System Test</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			margin: 20px;
			background: #f0f0f0;
		}
		.container {
			max-width: 1200px;
			margin: 0 auto;
			background: white;
			padding: 20px;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba( 0, 0, 0, 0.1 );
		}
		h1 {
			color: #333;
		}
		.test-section {
			margin: 20px 0;
			padding: 15px;
			background: #f9f9f9;
			border-left: 4px solid #4CAF50;
		}
		button {
			padding: 10px 20px;
			margin: 5px;
			background: #4CAF50;
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 14px;
		}
		button:hover {
			background: #45a049;
		}
		.output {
			margin-top: 10px;
			padding: 10px;
			background: white;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-family: monospace;
			white-space: pre-wrap;
		}
		.success {
			color: #4CAF50;
		}
		.error {
			color: #f44336;
		}
		#canvas-container {
			margin: 20px 0;
			height: 400px;
			background: #000;
			border-radius: 4px;
		}
	</style>
</head>
<body>
	<div class="container">
		<h1>Pi.js Plugin System Test</h1>
		
		<div class="test-section">
			<h2>Plugin Registration</h2>
			<button onclick="testPluginRegistration()">Test Plugin Registration</button>
			<button onclick="testGetPlugins()">Get Plugin List</button>
			<div id="registration-output" class="output"></div>
		</div>
		
		<div class="test-section">
			<h2>Global Commands</h2>
			<button onclick="testHelloCommand()">Test hello() Command</button>
			<button onclick="testGetLibraryInfo()">Test getLibraryInfo()</button>
			<div id="global-output" class="output"></div>
		</div>
		
		<div class="test-section">
			<h2>Screen Commands</h2>
			<button onclick="testTrackClick()">Test trackClick()</button>
			<button onclick="testDrawRandomCircle()">Draw Random Circles</button>
			<div id="screen-output" class="output"></div>
		</div>
		
		<div id="canvas-container"></div>
	</div>

	<!-- Load Pi.js -->
	<script src="../build/pi.js"></script>
	
	<!-- Define a custom plugin inline -->
	<script>
		// Custom inline plugin
		function customPlugin( pluginApi ) {
			pluginApi.addCommand( "customCommand", function( options ) {
				return `Custom plugin says: ${options.message || "Hello!"}`;
			}, [ "message" ] );
			
			pluginApi.addScreenCommand( "drawSquare", function( screenData, options ) {
				const x = options.x || 0;
				const y = options.y || 0;
				const size = options.size || 50;
				
				const ctx = screenData.context;
				ctx.fillStyle = screenData.color.s;
				ctx.fillRect( x, y, size, size );
			}, [ "x", "y", "size" ] );
		}
	</script>

	<!-- Test Scripts -->
	<script>
		let screen = null;
		
		// Initialize when ready
		pi.ready( () => {
			screen = pi.screen( {
				"aspect": "16:9",
				"container": "canvas-container"
			} );
			
			log( "registration-output", "✓ Pi.js initialized" );
			log( "screen-output", `✓ Screen created: ${screen.width()}x${screen.height()}` );
		} );
		
		function log( elementId, message, isError = false ) {
			const output = document.getElementById( elementId );
			const className = isError ? "error" : "success";
			output.innerHTML += `<span class="${className}">${message}</span>\n`;
			console.log( message );
		}
		
		function testPluginRegistration() {
			const output = document.getElementById( "registration-output" );
			output.innerHTML = "";
			
			try {
				pi.registerPlugin( {
					"name": "custom-plugin",
					"version": "1.0.0",
					"description": "A custom inline plugin",
					"init": customPlugin
				} );
				
				log( "registration-output", "✓ Plugin registered successfully" );
				
				// Test the custom command
				const result = pi.customCommand( "Testing!" );
				log( "registration-output", `✓ Custom command result: ${result}` );
				
				// Test duplicate registration (should fail)
				try {
					pi.registerPlugin( {
						"name": "custom-plugin",
						"init": customPlugin
					} );
					log( "registration-output", "✗ Duplicate registration should have failed", true );
				} catch( e ) {
					log( "registration-output", `✓ Duplicate prevention working: ${e.code}` );
				}
				
			} catch( error ) {
				log( "registration-output", `✗ Error: ${error.message}`, true );
			}
		}
		
		function testGetPlugins() {
			const output = document.getElementById( "registration-output" );
			output.innerHTML = "";
			
			const plugins = pi.getPlugins();
			log( "registration-output", `✓ Found ${plugins.length} plugin(s):` );
			plugins.forEach( p => {
				log( "registration-output", 
					`  - ${p.name} v${p.version} (${p.initialized ? "initialized" : "pending"})` );
			} );
		}
		
		function testHelloCommand() {
			const output = document.getElementById( "global-output" );
			output.innerHTML = "";
			
			try {
				// Note: hello() command comes from example-plugin which isn't loaded in this test
				// So this will fail unless we register a plugin with that command
				if( typeof pi.hello === "function" ) {
					const result1 = pi.hello( "Plugin System" );
					log( "global-output", `✓ hello() result: ${result1}` );
					
					const result2 = pi.hello();
					log( "global-output", `✓ hello() default: ${result2}` );
				} else {
					log( "global-output", 
						"ℹ hello() not available (example-plugin not loaded)", false );
					log( "global-output", 
						"  This is expected - load example-plugin.js to test this command" );
				}
			} catch( error ) {
				log( "global-output", `✗ Error: ${error.message}`, true );
			}
		}
		
		function testGetLibraryInfo() {
			const output = document.getElementById( "global-output" );
			output.innerHTML = "";
			
			try {
				if( typeof pi.getLibraryInfo === "function" ) {
					const info = pi.getLibraryInfo();
					log( "global-output", `✓ Library version: ${info.version}` );
					log( "global-output", `✓ Plugin system: ${info.pluginSystem}` );
				} else {
					log( "global-output", 
						"ℹ getLibraryInfo() not available (example-plugin not loaded)", false );
				}
			} catch( error ) {
				log( "global-output", `✗ Error: ${error.message}`, true );
			}
		}
		
		function testTrackClick() {
			const output = document.getElementById( "screen-output" );
			output.innerHTML = "";
			
			try {
				if( typeof pi.trackClick === "function" ) {
					const clicks1 = pi.trackClick( 100, 100 );
					log( "screen-output", `✓ Click tracked: ${clicks1}` );
					
					const clicks2 = pi.trackClick( 200, 150 );
					log( "screen-output", `✓ Click tracked: ${clicks2}` );
					
					const clicks3 = pi.trackClick( 300, 200 );
					log( "screen-output", `✓ Click tracked: ${clicks3}` );
				} else {
					log( "screen-output", 
						"ℹ trackClick() not available (example-plugin not loaded)", false );
				}
			} catch( error ) {
				log( "screen-output", `✗ Error: ${error.message}`, true );
			}
		}
		
		function testDrawRandomCircle() {
			const output = document.getElementById( "screen-output" );
			output.innerHTML = "";
			
			try {
				pi.clear();
				
				if( typeof pi.drawRandomCircle === "function" ) {
					// Draw several random circles
					for( let i = 0; i < 5; i++ ) {
						const x = Math.random() * pi.width();
						const y = Math.random() * pi.height();
						const r = 20 + Math.random() * 50;
						pi.drawRandomCircle( x, y, r );
					}
					log( "screen-output", "✓ Drew 5 random circles" );
				} else {
					log( "screen-output", 
						"ℹ drawRandomCircle() not available (example-plugin not loaded)", false );
					log( "screen-output", "  Testing with custom drawSquare() instead..." );
					
					// Test custom plugin command instead
					if( typeof pi.drawSquare === "function" ) {
						pi.clear();
						for( let i = 0; i < 5; i++ ) {
							const x = Math.random() * ( pi.width() - 50 );
							const y = Math.random() * ( pi.height() - 50 );
							const size = 30 + Math.random() * 40;
							pi.color( 
								Math.floor( Math.random() * 255 ),
								Math.floor( Math.random() * 255 ),
								Math.floor( Math.random() * 255 )
							);
							pi.drawSquare( x, y, size );
						}
						log( "screen-output", "✓ Drew 5 random squares using custom plugin" );
					}
				}
			} catch( error ) {
				log( "screen-output", `✗ Error: ${error.message}`, true );
			}
		}
	</script>
</body>
</html>

