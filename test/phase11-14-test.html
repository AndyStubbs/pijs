<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Phase 11-14: Input Systems Test</title>
	<style>
		body {
			margin: 0;
			padding: 20px;
			font-family: monospace;
			background: #222;
			color: #fff;
		}
		h1 {
			color: #4CAF50;
		}
		.status {
			margin: 20px 0;
			padding: 15px;
			background: #333;
			border-radius: 5px;
		}
		canvas {
			margin: 20px 0;
			display: block;
		}
		.info {
			background: #1a1a1a;
			padding: 15px;
			border-radius: 5px;
			margin: 20px 0;
		}
		.key {
			color: #4CAF50;
			font-weight: bold;
		}
	</style>
</head>
<body>
	<h1>Phase 11-14: Input Systems Test</h1>
	<div class="status" id="status">Loading Pi.js...</div>
	<div id="container" style="width: 640px; height: 400px;"></div>

	<div class="info">
		<h3>How to Test:</h3>
		<ul>
			<li><span class="key">Keyboard:</span> Press any key to see it display on screen</li>
			<li><span class="key">Mouse:</span> Move mouse over canvas, click to draw</li>
			<li><span class="key">Touch:</span> Touch/drag on canvas (on touch devices)</li>
			<li><span class="key">Gamepad:</span> Connect a controller and press buttons/move sticks</li>
			<li><span class="key">ESC:</span> Clear screen</li>
		</ul>
	</div>

	<script src="../build/pi.js"></script>
	<script>
		const status = document.getElementById( "status" );
		const $ = window.$ || window.pi;

		try {
			// Create screen
			const screen = $.screen( "640x400", "container" );

			status.innerHTML = "✅ Input systems test ready!";

			// Clear screen
			screen.cls();
			screen.setFont( 4 );  // Use 8x14 font

			// Keyboard test
			let keyPresses = [];
			let lastKeyTime = 0;

			$.onkey( null, "down", ( e ) => {
				const now = Date.now();
				
				// Clear old key presses after 5 seconds
				keyPresses = keyPresses.filter( k => now - k.time < 5000 );
				
				keyPresses.push( {
					"key": e.key,
					"code": e.code,
					"time": now
				} );
				lastKeyTime = now;
				
				// Clear screen if ESC
				if( e.key === "Escape" ) {
					screen.cls();
					keyPresses = [];
					return;
				}
				
				drawUI();
			} );

			// Mouse test
			screen.onmouse( "move", ( mouse ) => {
				drawUI( mouse );
			} );

			screen.onmouse( "down", ( mouse ) => {

				// Draw a circle where clicked
				screen.setColor( 11 );
				screen.circle( mouse.x, mouse.y, 5, 11 );
				screen.render();
			} );

			// Touch test
			screen.ontouch( "move", ( touch ) => {
				drawUI( null, touch );
			} );

			screen.ontouch( "start", ( touch ) => {

				// Draw a circle where touched
				screen.setColor( 14 );
				screen.circle( touch.x, touch.y, 8, 14 );
				screen.render();
			} );

			// Gamepad test
			let gamepads = [];
			let gamepadText = "No gamepad connected";
			let gamepadText2 = "";

			// Poll gamepads
			setInterval( () => {
				gamepads = $.ingamepads();
				if( gamepads.length > 0 ) {
					gamepadText = `Gamepads: ${gamepads.length}`;
					drawUI();
				}
			}, 100 );

			// Register gamepad events
			$.ongamepad( 0, "pressed", "*", ( e ) => {
				gamepadText2 = `Gamepad 0 Button ${e.item} pressed`;
				drawUI();
			} );

			$.ongamepad( 0, "axis", "*", ( e ) => {
				gamepadText2 = `Gamepad 0 Axis ${e.item}: ${e.value.toFixed( 2 )}`;
				drawUI();
			} );

			function drawUI( mouse, touch ) {
				const now = Date.now();
				
				// Only redraw if there's recent activity
				//if( now - lastKeyTime < 5000 || mouse || touch ) {
					screen.cls();
					screen.setColor( 15 );
					
					let y = 10;
					
					// Title
					screen.locate( 0, 0 );
					screen.setColor( 10 );
					screen.print( "INPUT SYSTEMS TEST", true, true );
					y += 20;
					
					// Keyboard section
					screen.locate( 2, 0 );
					screen.setColor( 14 );
					screen.print( "KEYBOARD:", false );
					y += 20;
					
					screen.setColor( 15 );
					if( keyPresses.length > 0 ) {
						const recent = keyPresses.slice( -10 );
						for( const kp of recent ) {
							screen.locate( Math.floor( y / 14 ), 2 );
							screen.print( `${kp.key} (${kp.code})`, false );
							y += 14;
						}
					} else {
						screen.locate( Math.floor( y / 14 ), 2 );
						screen.print( "Press any key...", false );
						y += 14;
					}
					
					y += 10;
					
					// Mouse section
					screen.locate( Math.floor( y / 14 ), 0 );
					screen.setColor( 11 );
					screen.print( "MOUSE:", false );
					y += 20;
					
					screen.setColor( 15 );
					if( mouse ) {
						screen.locate( Math.floor( y / 14 ), 2 );
						screen.print( `Position: ${mouse.x}, ${mouse.y}`, false );
						y += 14;
						screen.locate( Math.floor( y / 14 ), 2 );
						screen.print( `Buttons: ${mouse.buttons}`, false );
						y += 14;
					} else {
						screen.locate( Math.floor( y / 14 ), 2 );
						screen.print( "Move mouse over canvas...", false );
						y += 14;
					}
					
					y += 10;
					
					// Touch section
					screen.locate( Math.floor( y / 14 ), 0 );
					screen.setColor( 14 );
					screen.print( "TOUCH:", false );
					y += 20;
					
					screen.setColor( 15 );
					if( touch && touch.count > 0 ) {
						screen.locate( Math.floor( y / 14 ), 2 );
						screen.print( `Touches: ${touch.count}`, false );
						y += 14;
						screen.locate( Math.floor( y / 14 ), 2 );
						screen.print( `Position: ${touch.x}, ${touch.y}`, false );
						y += 14;
					} else {
						screen.locate( Math.floor( y / 14 ), 2 );
						screen.print( "Touch screen to test...", false );
						y += 14;
					}
					
					y += 10;
					
					// Gamepad section
					screen.locate( Math.floor( y / 14 ), 0 );
					screen.setColor( 13 );
					screen.print( "GAMEPAD:", false );
					y += 20;
					
					screen.setColor( 15 );
					screen.locate( Math.floor( y / 14 ), 2 );
					screen.print( gamepadText, false );
					screen.print( "  " + gamepadText2, false );
					
					screen.render();
				//}
			}

			// Initial draw
			drawUI();

			console.log( "✅ Input systems initialized!" );
			console.log( "Keyboard commands:", { "inkey": $.inkey, "onkey": $.onkey, "offkey": $.offkey } );
			console.log( "Mouse commands:", { "inmouse": screen.inmouse, "onmouse": screen.onmouse, "offmouse": screen.offmouse } );
			console.log( "Touch commands:", { "intouch": screen.intouch, "ontouch": screen.ontouch, "offtouch": screen.offtouch } );
			console.log( "Gamepad commands:", { "ingamepads": $.ingamepads, "ongamepad": $.ongamepad, "offgamepad": $.offgamepad } );

		} catch( e ) {
			status.innerHTML = `✗ Error: ${e.message}`;
			console.error( "Test failed:", e );
			throw e;
		}
	</script>
</body>
</html>

